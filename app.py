import os
from flask import Flask, render_template, request, redirect, url_for, session, flash, jsonify
import numpy as np
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime
import hashlib
from werkzeug.utils import secure_filename

# å¯¼å…¥ YOLO
from ultralytics import YOLO
# ============================================================
# ç—…è™«å®³ä¸­è‹±æ–‡æ˜ å°„è¡¨ + è¯¦ç»†èµ„æ–™
# å…± 38 ä¸ªç±»åˆ«ï¼Œä¸ä½ çš„æ¨¡å‹å®Œå…¨å¯¹åº”
# ============================================================

DISEASE_DATABASE = {
    # ==================== è‹¹æœ Apple ====================
    'apple apple scab': {
        'name_cn': 'è‹¹æœé»‘æ˜Ÿç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'è‹¹æœ',
        'symptoms': 'å¶ç‰‡å‡ºç°æ©„æ¦„ç»¿è‰²è‡³é»‘è‰²çš„åœ†å½¢ç—…æ–‘ï¼ŒåæœŸç—…æ–‘è¡¨é¢ç”Ÿå‡ºé»‘è‰²éœ‰å±‚ã€‚æœå®ä¸Šå½¢æˆé»‘è‰²ç–®ç—‚çŠ¶ç—…æ–‘ï¼Œå½±å“å¤–è§‚å’Œå“è´¨ã€‚',
        'cause': 'ç”±è‹¹æœé»‘æ˜Ÿç—…èŒ(Venturia inaequalis)å¼•èµ·ï¼Œæ¸©æš–æ½®æ¹¿ç¯å¢ƒæ˜“å‘ç—…ï¼Œæ˜¥å­£å¤šé›¨æ—¶å‘ç—…ä¸¥é‡ã€‚ç—…èŒåœ¨è½å¶ä¸Šè¶Šå†¬ã€‚',
        'prevention': '1. ç§‹å†¬å­£æ¸…é™¤è½å¶ï¼Œå‡å°‘èŒæº\n2. åˆç†ä¿®å‰ªï¼Œä¿æŒæ ‘å† é€šé£é€å…‰\n3. é€‰ç”¨æŠ—ç—…å“ç§\n4. æ˜¥å­£èŒèŠ½å‰å–·çŸ³ç¡«åˆå‰‚',
        'treatment': '1. å‘ç—…åˆæœŸå–·æ´’70%ç”²åŸºæ‰˜å¸ƒæ´¥1000å€æ¶²\n2. ä½¿ç”¨80%ä»£æ£®é”°é”Œ600-800å€æ¶²\n3. ä¸¥é‡æ—¶ä½¿ç”¨43%æˆŠå”‘é†‡3000å€æ¶²',
        'pesticides': 'ç”²åŸºæ‰˜å¸ƒæ´¥ã€ä»£æ£®é”°é”Œã€æˆŠå”‘é†‡ã€å¤šèŒçµã€è‹¯é†šç”²ç¯å”‘'
    },
    
    'apple black rot': {
        'name_cn': 'è‹¹æœé»‘è…ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'è‹¹æœ',
        'symptoms': 'æœå®å‡ºç°è¤è‰²è‡³é»‘è‰²è…çƒ‚æ–‘ï¼Œé€æ¸æ‰©å¤§ã€‚å¶ç‰‡å‡ºç°ç´«è‰²è¾¹ç¼˜çš„è¤è‰²åœ†å½¢æ–‘ç‚¹ï¼ŒåæœŸç—…æ–‘ä¸­å¤®å˜ç°ç™½è‰²ï¼Œä¸Šæœ‰å°é»‘ç‚¹ã€‚',
        'cause': 'ç”±è‘¡è„åº§è…”èŒ(Botryosphaeria obtusa)å¼•èµ·ï¼Œé€šè¿‡ä¼¤å£ä¾µæŸ“ï¼Œé«˜æ¸©é«˜æ¹¿æ¡ä»¶æœ‰åˆ©å‘ç—…ã€‚',
        'prevention': '1. åŠæ—¶æ¸…é™¤ç—…æœã€ç—…å¶å’Œæ¯æ\n2. é¿å…æœå®æœºæ¢°æŸä¼¤\n3. åŠ å¼ºæœå›­é€šé£\n4. å†¬å­£æ¸…å›­',
        'treatment': '1. å–·æ–½1:2:200æ³¢å°”å¤šæ¶²\n2. ä½¿ç”¨70%ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²\n3. å‘ç—…æœŸå–·æ–½10%è‹¯é†šç”²ç¯å”‘1500å€æ¶²',
        'pesticides': 'æ³¢å°”å¤šæ¶²ã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€è‹¯é†šç”²ç¯å”‘ã€ä»£æ£®é”°é”Œ'
    },
    
    'apple cedar apple rust': {
        'name_cn': 'è‹¹æœé”ˆç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'è‹¹æœ',
        'symptoms': 'å¶ç‰‡æ­£é¢å‡ºç°æ©™é»„è‰²åœ†å½¢ç—…æ–‘ï¼Œç—…æ–‘ä¸Šæœ‰æ©™é»„è‰²å°ç‚¹ã€‚å¶ç‰‡èƒŒé¢ç—…æ–‘å¤„éš†èµ·ï¼ŒåæœŸäº§ç”Ÿé»„è¤è‰²æ¯›çŠ¶ç‰©ï¼ˆé”ˆå­¢å­å™¨ï¼‰ã€‚',
        'cause': 'ç”±è‹¹æœé”ˆç—…èŒ(Gymnosporangium juniperi-virginianae)å¼•èµ·ï¼Œéœ€è¦æ¡§æŸä½œä¸ºè½¬ä¸»å¯„ä¸»å®Œæˆç”Ÿæ´»å²ã€‚',
        'prevention': '1. æ¸…é™¤æœå›­å‘¨å›´500ç±³å†…çš„æ¡§æŸ\n2. å¦‚æ— æ³•æ¸…é™¤æ¡§æŸï¼Œæ˜¥å­£åœ¨æ¡§æŸä¸Šå–·è¯\n3. è‹¹æœèŒèŠ½è‡³å¹¼æœæœŸå–·è¯ä¿æŠ¤',
        'treatment': '1. å–·æ–½15%ä¸‰å”‘é…®1500å€æ¶²\n2. ä½¿ç”¨12.5%è…ˆèŒå”‘2000å€æ¶²\n3. ä»£æ£®é”°é”Œ600å€æ¶²é¢„é˜²',
        'pesticides': 'ä¸‰å”‘é…®ã€è…ˆèŒå”‘ã€ä»£æ£®é”°é”Œã€æ°Ÿç¡…å”‘'
    },
    
    'apple healthy': {
        'name_cn': 'è‹¹æœï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'è‹¹æœ',
        'symptoms': 'å¶ç‰‡ç¿ ç»¿æœ‰å…‰æ³½ï¼Œå¶å½¢æ­£å¸¸ï¼Œæ— ç—…æ–‘ã€å˜è‰²æˆ–ç•¸å½¢ã€‚ææ¡ç”Ÿé•¿å¥å£®ï¼Œæœå®å‘è‚²è‰¯å¥½ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. ç»§ç»­ä¿æŒè‰¯å¥½çš„æœå›­ç®¡ç†\n2. åˆç†ä¿®å‰ªï¼Œä¿æŒé€šé£é€å…‰\n3. ç§‘å­¦æ–½è‚¥ï¼Œå¢å¼ºæ ‘åŠ¿\n4. å®šæœŸæ£€æŸ¥ï¼ŒåŠæ—¶å‘ç°é—®é¢˜',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯ï¼Œå¯è¿›è¡Œå¸¸è§„é¢„é˜²æ€§å–·è¯'
    },
    
    # ==================== é¦™è•‰ Banana ====================
    'banana healthy': {
        'name_cn': 'é¦™è•‰ï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'é¦™è•‰',
        'symptoms': 'å¶ç‰‡ç¿ ç»¿æŒºç«‹ï¼Œå¶ç¼˜å®Œæ•´ï¼Œæ— æ–‘ç‚¹æˆ–æ¡çº¹ã€‚å‡èŒç²—å£®ï¼Œæœç©—å‘è‚²æ­£å¸¸ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. ä¿æŒè‰¯å¥½çš„æ°´è‚¥ç®¡ç†\n2. åŠæ—¶é™¤å»æ¯å¶è€å¶\n3. é˜²æ²»èšœè™«ç­‰ä¼ æ¯’åª’ä»‹\n4. åˆç†å¯†æ¤',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯'
    },
    
    'banana segatoka': {
        'name_cn': 'é¦™è•‰å¶æ–‘ç—…ï¼ˆé»‘æ¡å¶æ–‘ç—…ï¼‰',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'é¦™è•‰',
        'symptoms': 'å¶ç‰‡åˆæœŸå‡ºç°æ·¡é»„è‰²å°æ–‘ç‚¹ï¼Œåæ‰©å¤§ä¸ºè¤è‰²è‡³é»‘è‰²æ¤­åœ†å½¢ç—…æ–‘ï¼Œç—…æ–‘å‘¨å›´æœ‰é»„è‰²æ™•åœˆã€‚ä¸¥é‡æ—¶ç—…æ–‘è¿ç‰‡ï¼Œå¶ç‰‡æ¯æ­»ã€‚',
        'cause': 'ç”±é¦™è•‰çƒè…”èŒ(Mycosphaerella fijiensis)å¼•èµ·ï¼Œé«˜æ¸©å¤šé›¨å­£èŠ‚å‘ç—…ä¸¥é‡ï¼Œå¯é€ æˆä¸¥é‡å‡äº§ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. åˆç†å¯†æ¤ï¼Œæ”¹å–„é€šé£\n3. åŠæ—¶æ¸…é™¤ç—…å¶\n4. é›¨å­£å‰å¼€å§‹å–·è¯é¢„é˜²',
        'treatment': '1. å–·æ–½25%ä¸™ç¯å”‘1500å€æ¶²\n2. ä½¿ç”¨80%ä»£æ£®é”°é”Œ600å€æ¶²\n3. äº¤æ›¿ä½¿ç”¨ä¸åŒè¯å‰‚',
        'pesticides': 'ä¸™ç¯å”‘ã€ä»£æ£®é”°é”Œã€è‹¯é†šç”²ç¯å”‘ã€å¡å”‘é†šèŒé…¯'
    },
    
    'banana xamthomonas': {
        'name_cn': 'é¦™è•‰ç»†èŒæ€§æ¡æ–‘ç—…',
        'category': 'ç»†èŒæ€§ç—…å®³',
        'affected_crops': 'é¦™è•‰',
        'symptoms': 'å¶ç‰‡å‡ºç°æ°´æµ¸çŠ¶æ¡æ–‘ï¼Œåå˜ä¸ºé»‘è¤è‰²ï¼Œæ²¿å¶è„‰æ‰©å±•ã€‚ä¸¥é‡æ—¶å¶ç‰‡å¤§é¢ç§¯æ¯æ­»ï¼Œæ¤æ ªçŸ®åŒ–ï¼Œæœå®å“è´¨ä¸‹é™ã€‚',
        'cause': 'ç”±é»„å•èƒæ†èŒ(Xanthomonas)å¼•èµ·ï¼Œé€šè¿‡é›¨æ°´é£æº…ã€ä¼¤å£ä¾µå…¥ä¼ æ’­ï¼Œé«˜æ¸©å¤šé›¨å­£èŠ‚å‘ç—…é‡ã€‚',
        'prevention': '1. ä½¿ç”¨æ— ç—…ç§è‹—\n2. é¿å…é€ æˆä¼¤å£\n3. å‘ç°ç—…æ ªåŠæ—¶æ‹”é™¤\n4. åŠ å¼ºç”°é—´å«ç”Ÿ',
        'treatment': '1. å–·æ–½77%æ°¢æ°§åŒ–é“œ500å€æ¶²\n2. ä½¿ç”¨20%å™»èŒé“œ500å€æ¶²\n3. é…åˆå†œç”¨é“¾éœ‰ç´ ä½¿ç”¨',
        'pesticides': 'æ°¢æ°§åŒ–é“œã€å™»èŒé“œã€å†œç”¨é“¾éœ‰ç´ ã€ä¸­ç”ŸèŒç´ '
    },
    
    # ==================== æ¨±æ¡ƒ Cherry ====================
    'cherry (including sour) healthy': {
        'name_cn': 'æ¨±æ¡ƒï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'æ¨±æ¡ƒï¼ˆåŒ…æ‹¬é…¸æ¨±æ¡ƒï¼‰',
        'symptoms': 'å¶ç‰‡ç¿ ç»¿æœ‰å…‰æ³½ï¼Œå¶å½¢æ­£å¸¸èˆ’å±•ï¼Œæ— ç—…æ–‘ã€ç™½ç²‰æˆ–ç•¸å½¢ã€‚æœå®å‘è‚²æ­£å¸¸ï¼Œè‰²æ³½é²œè‰³ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. ä¿æŒåˆç†çš„æ ‘å½¢ç»“æ„\n2. ç§‘å­¦æ–½è‚¥å’ŒçŒæº‰\n3. æ³¨æ„æœå›­é€šé£\n4. åŠæ—¶é˜²æ²»è™«å®³',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯'
    },
    
    'cherry (including sour) powdery mildew': {
        'name_cn': 'æ¨±æ¡ƒç™½ç²‰ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'æ¨±æ¡ƒï¼ˆåŒ…æ‹¬é…¸æ¨±æ¡ƒï¼‰',
        'symptoms': 'å¶ç‰‡è¡¨é¢è¦†ç›–ä¸€å±‚ç™½è‰²ç²‰çŠ¶ç‰©ï¼Œä¸¥é‡æ—¶å¶ç‰‡å·æ›²ã€å˜å½¢ã€æ—©è½ã€‚å¹¼æœå—å®³åå‘è‚²ä¸è‰¯æˆ–ç•¸å½¢ã€‚',
        'cause': 'ç”±ç™½ç²‰èŒ(Podosphaera clandestina)å¼•èµ·ï¼Œå¹²æ—±ã€æ˜¼å¤œæ¸©å·®å¤§ã€æ°®è‚¥è¿‡å¤šæ—¶å‘ç—…ä¸¥é‡ã€‚',
        'prevention': '1. åŠ å¼ºæœå›­é€šé£é€å…‰\n2. é¿å…æ°®è‚¥è¿‡é‡\n3. ç§‹å­£æ¸…é™¤ç—…å¶\n4. å‘ç—…å‰å–·è¯é¢„é˜²',
        'treatment': '1. å–·æ–½15%ä¸‰å”‘é…®1000å€æ¶²\n2. ä½¿ç”¨40%æ°Ÿç¡…å”‘5000å€æ¶²\n3. å‘ç—…åˆæœŸå–·æ–½50%ç¡«æ‚¬æµ®å‰‚300å€æ¶²',
        'pesticides': 'ä¸‰å”‘é…®ã€æ°Ÿç¡…å”‘ã€ç¡«æ‚¬æµ®å‰‚ã€è…ˆèŒå”‘ã€é†šèŒé…¯'
    },
    
    # ==================== ç‰ç±³ Corn ====================
    'corn (maize) cercospora leaf spot gray leaf spot': {
        'name_cn': 'ç‰ç±³ç°æ–‘ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'ç‰ç±³',
        'symptoms': 'å¶ç‰‡å‡ºç°ç°è‰²è‡³è¤è‰²çš„é•¿æ–¹å½¢æˆ–æ¡å½¢ç—…æ–‘ï¼Œç—…æ–‘è¾¹ç¼˜å¹³è¡Œäºå¶è„‰ï¼Œå‘ˆå…¸å‹çš„"ç°æ–‘"çŠ¶ã€‚ä¸¥é‡æ—¶å¶ç‰‡å¤§é¢ç§¯æ¯æ­»ã€‚',
        'cause': 'ç”±ç‰ç±³å°¾å­¢èŒ(Cercospora zeae-maydis)å¼•èµ·ï¼Œé«˜æ¸©é«˜æ¹¿æ¡ä»¶ä¸‹å‘ç—…ä¸¥é‡ï¼Œè¿ä½œç”°å‘ç—…é‡ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. åˆç†è½®ä½œ\n3. æ¸…é™¤ç”°é—´ç—…æ®‹ä½“\n4. åˆç†å¯†æ¤ï¼Œæ”¹å–„é€šé£',
        'treatment': '1. å‘ç—…åˆæœŸå–·æ–½10%è‹¯é†šç”²ç¯å”‘1500å€æ¶²\n2. ä½¿ç”¨25%å¡å”‘é†šèŒé…¯2000å€æ¶²\n3. ä»£æ£®é”°é”Œ600å€æ¶²',
        'pesticides': 'è‹¯é†šç”²ç¯å”‘ã€å¡å”‘é†šèŒé…¯ã€ä»£æ£®é”°é”Œã€ä¸™ç¯å”‘'
    },
    
    'corn (maize) common rust': {
        'name_cn': 'ç‰ç±³é”ˆç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'ç‰ç±³',
        'symptoms': 'å¶ç‰‡ä¸¤é¢æ•£ç”Ÿé‡‘é»„è‰²è‡³é”ˆè¤è‰²çš„ç–±çŠ¶å°çªèµ·ï¼ˆå¤å­¢å­å †ï¼‰ï¼Œç ´è£‚åæ•£å‡ºå¤§é‡é”ˆè¤è‰²ç²‰æœ«ï¼ˆå¤å­¢å­ï¼‰ã€‚',
        'cause': 'ç”±ç‰ç±³é”ˆç—…èŒ(Puccinia sorghi)å¼•èµ·ï¼Œæ¸©æš–æ½®æ¹¿æ¡ä»¶ä¸‹å‘ç—…ä¸¥é‡ï¼Œå­¢å­éšæ°”æµè¿œè·ç¦»ä¼ æ’­ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. é€‚æœŸæ’­ç§ï¼Œé¿å¼€å‘ç—…é«˜å³°\n3. åˆç†æ–½è‚¥ï¼Œå¢å¼ºæ¤æ ªæŠ—æ€§',
        'treatment': '1. å–·æ–½15%ä¸‰å”‘é…®1000å€æ¶²\n2. ä½¿ç”¨25%ä¸™ç¯å”‘1500å€æ¶²\n3. 12.5%æ°Ÿç¯å”‘2000å€æ¶²',
        'pesticides': 'ä¸‰å”‘é…®ã€ä¸™ç¯å”‘ã€æ°Ÿç¯å”‘ã€æˆŠå”‘é†‡'
    },
    
    'corn (maize) healthy': {
        'name_cn': 'ç‰ç±³ï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'ç‰ç±³',
        'symptoms': 'æ¤æ ªç”Ÿé•¿å¥å£®ï¼Œå¶ç‰‡å®½å¤§ç¿ ç»¿ï¼ŒèŒç§†ç²—å£®ï¼Œæ— ç—…æ–‘æˆ–é”ˆç²‰ã€‚æœç©—å‘è‚²æ­£å¸¸ï¼Œç±½ç²’é¥±æ»¡ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. ç»§ç»­ä¿æŒè‰¯å¥½çš„ç”°é—´ç®¡ç†\n2. åˆç†æ–½è‚¥çŒæº‰\n3. å®šæœŸæ£€æŸ¥ç—…è™«å®³\n4. åŠæ—¶ä¸­è€•é™¤è‰',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯'
    },
    
    'corn (maize) northern leaf blight': {
        'name_cn': 'ç‰ç±³å¤§æ–‘ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'ç‰ç±³',
        'symptoms': 'å¶ç‰‡å‡ºç°å¤§å‹æ¢­å½¢æˆ–é•¿æ¤­åœ†å½¢ç—…æ–‘ï¼Œåˆä¸ºæ°´æµ¸çŠ¶ï¼Œåå˜ç°ç»¿è‰²è‡³é»„è¤è‰²ï¼Œä¸¥é‡æ—¶ç—…æ–‘è¿ç‰‡ï¼Œå¶ç‰‡æ¯æ­»ã€‚',
        'cause': 'ç”±ç‰ç±³å¤§æ–‘ç—…èŒ(Exserohilum turcicum)å¼•èµ·ï¼Œä¸­æ¸©ï¼ˆ20-25â„ƒï¼‰é«˜æ¹¿æ¡ä»¶ä¸‹å‘ç—…ä¸¥é‡ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. åˆç†å¯†æ¤\n3. å¢æ–½ç£·é’¾è‚¥ï¼Œå¢å¼ºæŠ—æ€§\n4. æ”¶è·åæ¸…é™¤ç—…æ®‹ä½“',
        'treatment': '1. å‘ç—…åˆæœŸå–·æ–½50%å¤šèŒçµ500å€æ¶²\n2. ä½¿ç”¨70%ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²\n3. ä»£æ£®é”°é”Œ600å€æ¶²',
        'pesticides': 'å¤šèŒçµã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€ä»£æ£®é”°é”Œã€è‹¯é†šç”²ç¯å”‘'
    },
    
    # ==================== è‘¡è„ Grape ====================
    'grape black rot': {
        'name_cn': 'è‘¡è„é»‘è…ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'è‘¡è„',
        'symptoms': 'å¶ç‰‡å‡ºç°çº¢è¤è‰²åœ†å½¢ç—…æ–‘ï¼Œè¾¹ç¼˜é¢œè‰²è¾ƒæ·±ï¼Œä¸Šæœ‰å°é»‘ç‚¹ã€‚æœå®æŸ“ç—…åå˜è¤ã€è…çƒ‚ï¼Œæœ€åå¹²ç¼©æˆé»‘è‰²åƒµæœã€‚',
        'cause': 'ç”±è‘¡è„é»‘è…ç—…èŒ(Guignardia bidwellii)å¼•èµ·ï¼Œé«˜æ¸©å¤šé›¨å­£èŠ‚å‘ç—…ä¸¥é‡ï¼Œåƒµæœæ˜¯ä¸»è¦ä¾µæŸ“æºã€‚',
        'prevention': '1. å½»åº•æ¸…é™¤åƒµæœå’Œç—…å¶\n2. åŠ å¼ºæœå›­é€šé£é€å…‰\n3. é›¨å­£åŠæ—¶æ’æ°´\n4. èŠ±å‰èŠ±åé‡ç‚¹å–·è¯',
        'treatment': '1. å–·æ–½1:0.7:200æ³¢å°”å¤šæ¶²\n2. ä½¿ç”¨80%ä»£æ£®é”°é”Œ600å€æ¶²\n3. ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²',
        'pesticides': 'æ³¢å°”å¤šæ¶²ã€ä»£æ£®é”°é”Œã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€è‹¯é†šç”²ç¯å”‘'
    },
    
    'grape esca (black measles)': {
        'name_cn': 'è‘¡è„é»‘éº»ç–¹ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'è‘¡è„',
        'symptoms': 'å¶ç‰‡å‡ºç°"è™çš®çŠ¶"æ–‘çº¹ï¼Œå¶ç¼˜å’Œå¶è„‰é—´ç»„ç»‡åæ­»ã€‚æœå®è¡¨é¢å‡ºç°è¤è‰²è‡³ç´«é»‘è‰²å°æ–‘ç‚¹ï¼Œä¸¥é‡æ—¶æœå®å¹²ç¼©ã€‚',
        'cause': 'ç”±å¤šç§çœŸèŒï¼ˆä¸»è¦æ˜¯Phaeomoniellaå’ŒPhaeoacremoniumï¼‰å¤åˆä¾µæŸ“å¼•èµ·ï¼Œé€šè¿‡ä¿®å‰ªä¼¤å£ä¾µå…¥ã€‚',
        'prevention': '1. ä¿®å‰ªæ—¶æ¶ˆæ¯’å‰ªåˆ€\n2. ä¿®å‰ªä¼¤å£æ¶‚æŠ¹ä¿æŠ¤å‰‚\n3. é¿å…å¤§ä¼¤å£\n4. é€‰ç”¨å¥åº·è‹—æœ¨',
        'treatment': '1. ç›®å‰æ— ç‰¹æ•ˆè¯\n2. ä¸¥é‡ç—…æ ªæŒ–é™¤çƒ§æ¯\n3. ä¿®å‰ªä¼¤å£æ¶‚æŠ¹ç”²åŸºæ‰˜å¸ƒæ´¥ç³Šå‰‚',
        'pesticides': 'ä¼¤å£ä¿æŠ¤å‰‚ã€ç”²åŸºæ‰˜å¸ƒæ´¥ç³Šå‰‚ï¼ˆä»¥é¢„é˜²ä¸ºä¸»ï¼‰'
    },
    
    'grape healthy': {
        'name_cn': 'è‘¡è„ï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'è‘¡è„',
        'symptoms': 'å¶ç‰‡ç¿ ç»¿æœ‰å…‰æ³½ï¼Œå¶å½¢æ­£å¸¸ï¼Œæ— ç—…æ–‘ã€éœ‰å±‚æˆ–ç•¸å½¢ã€‚ææ¡å¥å£®ï¼Œæœç©—å‘è‚²è‰¯å¥½ï¼Œæœç²’é¥±æ»¡ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. ä¿æŒæœå›­é€šé£é€å…‰\n2. åˆç†ä¿®å‰ªå’Œç»‘è”“\n3. ç§‘å­¦æ–½è‚¥çŒæº‰\n4. å®šæœŸç—…è™«å®³æ£€æŸ¥',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯'
    },
    
    'grape leaf blight (isariopsis leaf spot)': {
        'name_cn': 'è‘¡è„å¶æ¯ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'è‘¡è„',
        'symptoms': 'å¶ç‰‡å‡ºç°ä¸è§„åˆ™å½¢è¤è‰²ç—…æ–‘ï¼Œè¾¹ç¼˜ç•¥å¸¦ç´«è‰²ï¼ŒåæœŸç—…æ–‘å¹²æ¯ç ´è£‚ã€‚ä¸¥é‡æ—¶å¶ç‰‡ææ—©è„±è½ï¼Œå½±å“æ ‘åŠ¿å’Œæœå®å“è´¨ã€‚',
        'cause': 'ç”±è‘¡è„å¶æ¯ç—…èŒ(Isariopsis clavispora)å¼•èµ·ï¼Œå¤šé›¨æ½®æ¹¿æ¡ä»¶ä¸‹å‘ç—…ä¸¥é‡ã€‚',
        'prevention': '1. åŠæ—¶æ¸…é™¤è½å¶\n2. åŠ å¼ºé€šé£é€å…‰\n3. é¿å…è¿‡åº¦å¯†æ¤\n4. é›¨å­£æ³¨æ„æ’æ°´',
        'treatment': '1. å–·æ–½80%ä»£æ£®é”°é”Œ600å€æ¶²\n2. ä½¿ç”¨75%ç™¾èŒæ¸…500å€æ¶²\n3. ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²',
        'pesticides': 'ä»£æ£®é”°é”Œã€ç™¾èŒæ¸…ã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€ç¦ç¾åŒ'
    },
    
    # ==================== æŸ‘æ©˜ Orange ====================
    'orange haunglongbing (citrus greening)': {
        'name_cn': 'æŸ‘æ©˜é»„é¾™ç—…',
        'category': 'ç»†èŒæ€§ç—…å®³',
        'affected_crops': 'æŸ‘æ©˜ç±»ï¼ˆæ©™ã€æŸšã€æŸ æª¬ç­‰ï¼‰',
        'symptoms': 'å¶ç‰‡é»„åŒ–ï¼Œå‘ˆæ–‘é©³çŠ¶ï¼Œæ–°å¶å°è€Œç›´ç«‹ã€‚æœå®ç•¸å½¢ã€åå°ã€ç€è‰²ä¸å‡ï¼Œæœè‚‰å‘³è‹¦ï¼Œç§å­è´¥è‚²ã€‚æ¤æ ªé€æ¸è¡°é€€æ­»äº¡ã€‚',
        'cause': 'ç”±éŸ§çš®éƒ¨æ†èŒ(Candidatus Liberibacter)å¼•èµ·ï¼Œä¸»è¦é€šè¿‡æœ¨è™±ä¼ æ’­ï¼Œæ˜¯æŸ‘æ©˜äº§ä¸šçš„æ¯ç­æ€§ç—…å®³ã€‚',
        'prevention': '1. ä¸¥æ ¼ä½¿ç”¨æ— ç—…è‹—æœ¨\n2. å½»åº•é˜²æ²»æŸ‘æ©˜æœ¨è™±\n3. å»ºç«‹æ— ç—…æœå›­\n4. å‘ç°ç—…æ ‘ç«‹å³æŒ–é™¤çƒ§æ¯',
        'treatment': '1. ç›®å‰æ— æ³•æ²»æ„ˆ\n2. å‘ç—…åˆæœŸæ³¨å°„æŠ—ç”Ÿç´ å¯å»¶ç¼“ç—…æƒ…\n3. ç—…æ ‘å¿…é¡»æŒ–é™¤é”€æ¯\n4. é‡ç‚¹é˜²æ²»æœ¨è™±',
        'pesticides': 'é˜²æ²»æœ¨è™±ï¼šå¡è™«å•‰ã€å™»è™«å—ªã€é«˜æ•ˆæ°¯æ°°èŠé…¯'
    },
    
    # ==================== è¾£æ¤’ Pepper ====================
    'pepper, bell bacterial spot': {
        'name_cn': 'ç”œæ¤’ç»†èŒæ€§æ–‘ç‚¹ç—…',
        'category': 'ç»†èŒæ€§ç—…å®³',
        'affected_crops': 'ç”œæ¤’ã€è¾£æ¤’',
        'symptoms': 'å¶ç‰‡å‡ºç°æ°´æµ¸çŠ¶å°æ–‘ç‚¹ï¼Œåå˜ä¸ºè¤è‰²è‡³é»‘è‰²ï¼Œç•¥å‡¹é™·ï¼Œå‘¨å›´æœ‰é»„è‰²æ™•åœˆã€‚æœå®ä¸Šå½¢æˆç–®ç—‚çŠ¶çªèµ·ï¼Œå½±å“å¤–è§‚å’Œå“è´¨ã€‚',
        'cause': 'ç”±ä¸é¦™å‡å•èƒæ†èŒ(Xanthomonas vesicatoria)å¼•èµ·ï¼Œé«˜æ¸©å¤šé›¨æ—¶å‘ç—…ä¸¥é‡ï¼Œç§å­å¯å¸¦èŒã€‚',
        'prevention': '1. ä½¿ç”¨æ— ç—…ç§å­\n2. ç§å­æ¶ˆæ¯’å¤„ç†\n3. é¿å…è¿ä½œ\n4. æ§åˆ¶ç”°é—´æ¹¿åº¦',
        'treatment': '1. å–·æ–½72%å†œç”¨é“¾éœ‰ç´ 3000å€æ¶²\n2. ä½¿ç”¨77%æ°¢æ°§åŒ–é“œ500å€æ¶²\n3. 20%å™»èŒé“œ500å€æ¶²',
        'pesticides': 'å†œç”¨é“¾éœ‰ç´ ã€æ°¢æ°§åŒ–é“œã€å™»èŒé“œã€ä¸­ç”ŸèŒç´ '
    },
    
    'pepper, bell healthy': {
        'name_cn': 'ç”œæ¤’ï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'ç”œæ¤’ã€è¾£æ¤’',
        'symptoms': 'æ¤æ ªç”Ÿé•¿å¥å£®ï¼Œå¶ç‰‡æ·±ç»¿æœ‰å…‰æ³½ï¼Œæ— æ–‘ç‚¹æˆ–ç•¸å½¢ã€‚æœå®å‘è‚²æ­£å¸¸ï¼Œè‰²æ³½é²œè‰³ï¼Œè¡¨é¢å…‰æ»‘ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. ä¿æŒè‰¯å¥½çš„æ ½åŸ¹ç®¡ç†\n2. åˆç†æ–½è‚¥çŒæº‰\n3. åŠæ—¶æ•´ææ‰“æˆ\n4. æ³¨æ„é€šé£æ¢æ°”',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯'
    },
    
    # ==================== é©¬é“ƒè–¯ Potato ====================
    'potato early blight': {
        'name_cn': 'é©¬é“ƒè–¯æ—©ç–«ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'é©¬é“ƒè–¯ã€ç•ªèŒ„',
        'symptoms': 'å¶ç‰‡å‡ºç°è¤è‰²åœ†å½¢ç—…æ–‘ï¼Œæœ‰æ˜æ˜¾çš„åŒå¿ƒè½®çº¹ï¼Œå½¢ä¼¼é¶æ ‡æˆ–ç‰›çœ¼ã€‚ä¸‹éƒ¨è€å¶å…ˆå‘ç—…ï¼Œé€æ¸å‘ä¸Šè”“å»¶ã€‚',
        'cause': 'ç”±é“¾æ ¼å­¢èŒ(Alternaria solani)å¼•èµ·ï¼Œé«˜æ¸©å¹²æ—±åé‡é›¨æ˜“å‘ç—…ï¼Œæ¤æ ªè¡°å¼±æ—¶å‘ç—…é‡ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. åˆç†è½®ä½œ\n3. å¢æ–½ç£·é’¾è‚¥\n4. é¿å…ç¼ºæ°´ç¼ºè‚¥',
        'treatment': '1. å‘ç—…åˆæœŸå–·æ–½75%ç™¾èŒæ¸…500å€æ¶²\n2. ä½¿ç”¨80%ä»£æ£®é”°é”Œ600å€æ¶²\n3. è‹¯é†šç”²ç¯å”‘1500å€æ¶²',
        'pesticides': 'ç™¾èŒæ¸…ã€ä»£æ£®é”°é”Œã€è‹¯é†šç”²ç¯å”‘ã€å˜§èŒé…¯'
    },
    
    'potato healthy': {
        'name_cn': 'é©¬é“ƒè–¯ï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'é©¬é“ƒè–¯',
        'symptoms': 'æ¤æ ªç”Ÿé•¿å¥å£®ï¼Œå¶ç‰‡ç¿ ç»¿å¹³å±•ï¼Œæ— ç—…æ–‘æˆ–éœ‰å±‚ã€‚èŒç§†ç²—å£®ï¼Œå—èŒå‘è‚²æ­£å¸¸ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. ä½¿ç”¨è„±æ¯’ç§è–¯\n2. åˆç†è½®ä½œ\n3. é«˜å„æ ½åŸ¹\n4. é€‚æ—¶åŸ¹åœŸ',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯'
    },
    
    'potato late blight': {
        'name_cn': 'é©¬é“ƒè–¯æ™šç–«ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'é©¬é“ƒè–¯ã€ç•ªèŒ„',
        'symptoms': 'å¶ç‰‡å‡ºç°æ°´æµ¸çŠ¶æš—ç»¿è‰²ç—…æ–‘ï¼Œè¿…é€Ÿæ‰©å¤§å˜è¤ã€‚æ½®æ¹¿æ—¶å¶èƒŒç—…æ–‘è¾¹ç¼˜äº§ç”Ÿç™½è‰²éœ‰å±‚ã€‚å—èŒè¡¨é¢å‡ºç°è¤è‰²æ–‘å—ï¼Œå†…éƒ¨è…çƒ‚ã€‚',
        'cause': 'ç”±è‡´ç—…ç–«éœ‰(Phytophthora infestans)å¼•èµ·ï¼Œä½æ¸©ï¼ˆ15-20â„ƒï¼‰é«˜æ¹¿æ¡ä»¶ä¸‹å‘ç—…ä¸¥é‡ï¼Œæ˜¯é©¬é“ƒè–¯çš„æ¯ç­æ€§ç—…å®³ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. ä½¿ç”¨è„±æ¯’ç§è–¯\n3. é«˜å„æ ½åŸ¹ï¼Œåˆ©äºæ’æ°´\n4. å‘ç—…å‰å¼€å§‹å–·è¯ä¿æŠ¤',
        'treatment': '1. å‘ç—…åˆæœŸå–·æ–½72%éœœè„²æ°°Â·é”°é”Œ600å€æ¶²\n2. ä½¿ç”¨68%ç²¾ç”²éœœÂ·é”°é”Œ600å€æ¶²\n3. 69%çƒ¯é…°Â·é”°é”Œ600å€æ¶²',
        'pesticides': 'éœœè„²æ°°ã€ç”²éœœçµã€çƒ¯é…°å—å•‰ã€ä»£æ£®é”°é”Œã€æ°Ÿå¡èŒèƒº'
    },
    
    # ==================== è‰è“ Strawberry ====================
    'strawberry healthy': {
        'name_cn': 'è‰è“ï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'è‰è“',
        'symptoms': 'æ¤æ ªçŸ®å£®ï¼Œå¶ç‰‡ç¿ ç»¿å¹³å±•ï¼Œå¶ç¼˜æ•´é½ã€‚èŠ±æœµæ­£å¸¸ï¼Œæœå®å‘è‚²è‰¯å¥½ï¼Œè‰²æ³½é²œè‰³ï¼Œé£å‘³ä½³ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. é€‰ç”¨å¥åº·ç§è‹—\n2. åˆç†æ–½è‚¥\n3. ä¿æŒé€‚å½“æ¹¿åº¦\n4. åŠæ—¶æ‘˜é™¤è€å¶ç—…å¶',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯'
    },
    
    'strawberry leaf scorch': {
        'name_cn': 'è‰è“å¶ç„¦ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'è‰è“',
        'symptoms': 'å¶ç‰‡å‡ºç°ç´«çº¢è‰²å°æ–‘ç‚¹ï¼Œåæ‰©å¤§ä¸ºä¸è§„åˆ™å½¢ç—…æ–‘ï¼Œç—…æ–‘ä¸­å¤®ä¸å˜ç°ç™½ï¼ˆä¸å¶æ–‘ç—…åŒºåˆ«ï¼‰ã€‚ä¸¥é‡æ—¶å¶ç‰‡ç„¦æ¯ï¼Œå½±å“äº§é‡ã€‚',
        'cause': 'ç”±è‰è“å¶ç„¦ç—…èŒ(Diplocarpon earliana)å¼•èµ·ï¼Œæ˜¥æœ«å¤åˆå¤šé›¨å­£èŠ‚å‘ç—…ä¸¥é‡ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. æ¸…é™¤ç—…æ®‹ä½“\n3. æ§åˆ¶ç§æ¤å¯†åº¦\n4. é¿å…è¿‡é‡æ–½ç”¨æ°®è‚¥',
        'treatment': '1. å–·æ–½80%ä»£æ£®é”°é”Œ600å€æ¶²\n2. ä½¿ç”¨70%ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²\n3. 10%è‹¯é†šç”²ç¯å”‘1500å€æ¶²',
        'pesticides': 'ä»£æ£®é”°é”Œã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€è‹¯é†šç”²ç¯å”‘ã€è…ˆèŒå”‘'
    },
    
    # ==================== èŒ¶å¶ Tea ====================
    'tea leaf blight': {
        'name_cn': 'èŒ¶å¶æ¯ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'èŒ¶æ ‘',
        'symptoms': 'å¶ç¼˜æˆ–å¶å°–å¼€å§‹å‘ç—…ï¼Œåˆä¸ºé»„è¤è‰²ï¼Œåæ‰©å±•ä¸ºä¸è§„åˆ™å½¢å¤§æ–‘ï¼Œç—…å¥äº¤ç•Œå¤„æœ‰æ·±è¤è‰²éš†èµ·çº¿ã€‚åæœŸç—…å¶æ¯ç„¦è„±è½ã€‚',
        'cause': 'ç”±èŒ¶è½®æ–‘ç—…èŒ(Pestalotiopsis theae)ç­‰å¼•èµ·ï¼Œé«˜æ¸©é«˜æ¹¿å­£èŠ‚å‘ç—…é‡ï¼Œæ ‘åŠ¿è¡°å¼±æ—¶æ˜“æ„Ÿç—…ã€‚',
        'prevention': '1. åŠ å¼ºèŒ¶å›­ç®¡ç†\n2. å¢æ–½æœ‰æœºè‚¥\n3. åˆç†ä¿®å‰ª\n4. åŠæ—¶æ¸…é™¤ç—…å¶',
        'treatment': '1. å–·æ–½75%ç™¾èŒæ¸…600å€æ¶²\n2. ä½¿ç”¨70%ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²\n3. ä»£æ£®é”°é”Œ600å€æ¶²',
        'pesticides': 'ç™¾èŒæ¸…ã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€ä»£æ£®é”°é”Œã€æ³¢å°”å¤šæ¶²'
    },
    
    'tea red leaf spot': {
               'name_cn': 'èŒ¶çº¢å¶æ–‘ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'èŒ¶æ ‘',
        'symptoms': 'å¶ç‰‡ä¸Šå‡ºç°çº¢è¤è‰²åœ†å½¢æˆ–ä¸è§„åˆ™å½¢ç—…æ–‘ï¼Œè¾¹ç¼˜é¢œè‰²è¾ƒæ·±ï¼Œç—…æ–‘ä¸Šæ•£ç”Ÿå°é»‘ç‚¹ã€‚ä¸¥é‡æ—¶å¶ç‰‡ææ—©è„±è½ã€‚',
        'cause': 'ç”±èŒ¶å¶æ–‘ç—…èŒå¼•èµ·ï¼Œé«˜æ¸©å¤šæ¹¿å­£èŠ‚å‘ç—…ä¸¥é‡ï¼Œç®¡ç†ç²—æ”¾çš„èŒ¶å›­å‘ç—…é‡ã€‚',
        'prevention': '1. åŠ å¼ºèŒ¶å›­ç®¡ç†ï¼Œå¢å¼ºæ ‘åŠ¿\n2. åˆç†æ–½è‚¥ï¼Œé¿å…åæ–½æ°®è‚¥\n3. é€‚æ—¶ä¿®å‰ªï¼Œä¿æŒé€šé£\n4. åŠæ—¶æ¸…é™¤ç—…å¶',
        'treatment': '1. å–·æ–½75%ç™¾èŒæ¸…600å€æ¶²\n2. ä½¿ç”¨70%ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²\n3. 50%å¤šèŒçµ600å€æ¶²',
        'pesticides': 'ç™¾èŒæ¸…ã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€å¤šèŒçµã€ä»£æ£®é”°é”Œ'
    },
    
    'tea red scab': {
        'name_cn': 'èŒ¶èµ¤å¶æ–‘ç—…ï¼ˆèŒ¶çº¢é”ˆç—…ï¼‰',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'èŒ¶æ ‘',
        'symptoms': 'å«©å¶å’Œå«©æ¢¢ä¸Šå‡ºç°æ·¡é»„è‰²è‡³çº¢è¤è‰²ç—…æ–‘ï¼Œè¡¨é¢äº§ç”Ÿç°ç™½è‰²ç²‰çŠ¶ç‰©ã€‚ä¸¥é‡æ—¶æ–°æ¢¢æ¯æ­»ï¼Œå½±å“èŒ¶å¶äº§é‡å’Œå“è´¨ã€‚',
        'cause': 'ç”±èŒ¶é¥¼ç—…èŒ(Exobasidium vexans)å¼•èµ·ï¼Œä½æ¸©é«˜æ¹¿æ¡ä»¶ä¸‹å‘ç—…ä¸¥é‡ï¼Œæ˜¥èŒ¶æœŸæœ€æ˜“å‘ç”Ÿã€‚',
        'prevention': '1. åŠ å¼ºèŒ¶å›­é€šé£é€å…‰\n2. åŠæ—¶é‡‡æ‘˜ï¼Œå‡å°‘ä¾µæŸ“æº\n3. æ¸…é™¤ç—…å¶ç—…æ¢¢\n4. æ—©æ˜¥å–·è¯é¢„é˜²',
        'treatment': '1. å–·æ–½15%ä¸‰å”‘é…®1000å€æ¶²\n2. ä½¿ç”¨75%ç™¾èŒæ¸…600å€æ¶²\n3. 70%ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²',
        'pesticides': 'ä¸‰å”‘é…®ã€ç™¾èŒæ¸…ã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€æ³¢å°”å¤šæ¶²'
    },
    
    # ==================== ç•ªèŒ„ Tomato ====================
    'tomato bacterial spot': {
        'name_cn': 'ç•ªèŒ„ç»†èŒæ€§æ–‘ç‚¹ç—…',
        'category': 'ç»†èŒæ€§ç—…å®³',
        'affected_crops': 'ç•ªèŒ„ã€è¾£æ¤’',
        'symptoms': 'å¶ç‰‡å‡ºç°æ·±è¤è‰²æ°´æµ¸çŠ¶å°æ–‘ç‚¹ï¼Œåå˜é»‘è¤è‰²ï¼Œå‘¨å›´æœ‰æˆ–æ— é»„è‰²æ™•åœˆã€‚æœå®ä¸Šå½¢æˆç¨éš†èµ·çš„ç–®ç—‚çŠ¶å°æ–‘ç‚¹ã€‚',
        'cause': 'ç”±ä¸é¦™å‡å•èƒæ†èŒç•ªèŒ„è‡´ç—…å˜ç§(Xanthomonas vesicatoria)å¼•èµ·ï¼Œé«˜æ¸©å¤šé›¨æ—¶å‘ç—…ä¸¥é‡ï¼Œç§å­å’Œç—…æ®‹ä½“å¸¦èŒã€‚',
        'prevention': '1. é€‰ç”¨æ— ç—…ç§å­\n2. ç§å­æ¸©æ±¤æ¶ˆæ¯’\n3. é¿å…è¿ä½œ\n4. æ§åˆ¶ç”°é—´æ¹¿åº¦',
        'treatment': '1. å–·æ–½72%å†œç”¨é“¾éœ‰ç´ 3000å€æ¶²\n2. ä½¿ç”¨77%æ°¢æ°§åŒ–é“œ500å€æ¶²\n3. 20%å™»èŒé“œ500å€æ¶²',
        'pesticides': 'å†œç”¨é“¾éœ‰ç´ ã€æ°¢æ°§åŒ–é“œã€å™»èŒé“œã€ä¸­ç”ŸèŒç´ ã€æ˜¥é›·éœ‰ç´ '
    },
    
    'tomato early blight': {
        'name_cn': 'ç•ªèŒ„æ—©ç–«ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'ç•ªèŒ„ã€é©¬é“ƒè–¯',
        'symptoms': 'å¶ç‰‡å‡ºç°è¤è‰²åœ†å½¢ç—…æ–‘ï¼Œæœ‰æ˜æ˜¾çš„åŒå¿ƒè½®çº¹ï¼Œå½¢ä¼¼é¶æ ‡ã€‚èŒéƒ¨å‡ºç°è¤è‰²æ¤­åœ†å½¢ç—…æ–‘ï¼Œç¨å‡¹é™·ã€‚ä¸‹éƒ¨è€å¶å…ˆå‘ç—…ã€‚',
        'cause': 'ç”±é“¾æ ¼å­¢èŒ(Alternaria solani)å¼•èµ·ï¼Œé«˜æ¸©é«˜æ¹¿äº¤æ›¿å‡ºç°æ—¶å‘ç—…ä¸¥é‡ï¼Œæ¤æ ªè¡°å¼±æ—¶æ˜“æ„Ÿç—…ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. åˆç†è½®ä½œ\n3. å¢æ–½ç£·é’¾è‚¥\n4. åŠæ—¶æ¸…é™¤ä¸‹éƒ¨è€å¶ç—…å¶',
        'treatment': '1. å–·æ–½75%ç™¾èŒæ¸…500å€æ¶²\n2. ä½¿ç”¨80%ä»£æ£®é”°é”Œ600å€æ¶²\n3. 10%è‹¯é†šç”²ç¯å”‘1500å€æ¶²',
        'pesticides': 'ç™¾èŒæ¸…ã€ä»£æ£®é”°é”Œã€è‹¯é†šç”²ç¯å”‘ã€å˜§èŒé…¯ã€å¼‚èŒè„²'
    },
    
    'tomato healthy': {
        'name_cn': 'ç•ªèŒ„ï¼ˆå¥åº·ï¼‰',
        'category': 'å¥åº·çŠ¶æ€',
        'affected_crops': 'ç•ªèŒ„',
        'symptoms': 'æ¤æ ªç”Ÿé•¿å¥å£®ï¼ŒèŒç§†ç²—å£®ã€‚å¶ç‰‡ç¿ ç»¿å¹³å±•ï¼Œæ— ç—…æ–‘ã€éœ‰å±‚æˆ–å·æ›²ã€‚èŠ±åºæ­£å¸¸ï¼Œæœå®å‘è‚²è‰¯å¥½ï¼Œç€è‰²å‡åŒ€ã€‚',
        'cause': 'æ— ç—…å®³',
        'prevention': '1. ä¿æŒè‰¯å¥½çš„æ ½åŸ¹ç¯å¢ƒ\n2. åˆç†æ•´ææ‰“æˆ\n3. ç§‘å­¦æ°´è‚¥ç®¡ç†\n4. æ³¨æ„é€šé£æ¢æ°”',
        'treatment': 'æ— éœ€æ²»ç–—',
        'pesticides': 'æ— éœ€ç”¨è¯'
    },
    
    'tomato late blight': {
        'name_cn': 'ç•ªèŒ„æ™šç–«ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'ç•ªèŒ„ã€é©¬é“ƒè–¯',
        'symptoms': 'å¶ç‰‡å‡ºç°æ°´æµ¸çŠ¶æš—ç»¿è‰²ç—…æ–‘ï¼Œè¿…é€Ÿæ‰©å¤§å˜è¤ï¼Œæ¹¿åº¦å¤§æ—¶å¶èƒŒç—…æ–‘è¾¹ç¼˜äº§ç”Ÿç™½è‰²éœ‰å±‚ã€‚æœå®å‡ºç°æ²¹æµ¸çŠ¶è¤è‰²ç¡¬æ–‘å—ã€‚',
        'cause': 'ç”±è‡´ç—…ç–«éœ‰(Phytophthora infestans)å¼•èµ·ï¼Œä½æ¸©ï¼ˆ15-20â„ƒï¼‰é«˜æ¹¿æ¡ä»¶ä¸‹å‘ç—…è¿…é€Ÿï¼Œæ˜¯ç•ªèŒ„æ¯ç­æ€§ç—…å®³ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. å¤§æ£šæ³¨æ„é€šé£é™æ¹¿\n3. é¿å…å¤§æ°´æ¼«çŒ\n4. å‘ç°ç—…æ ªåŠæ—¶æ‹”é™¤',
        'treatment': '1. å‘ç—…åˆæœŸå–·æ–½72%éœœè„²æ°°Â·é”°é”Œ600å€æ¶²\n2. ä½¿ç”¨68%ç²¾ç”²éœœÂ·é”°é”Œ600å€æ¶²\n3. 52.5%å™é…®Â·éœœè„²æ°°1500å€æ¶²',
        'pesticides': 'éœœè„²æ°°ã€ç”²éœœçµã€çƒ¯é…°å—å•‰ã€æ°Ÿå¡èŒèƒºã€ä»£æ£®é”°é”Œ'
    },
    
    'tomato leaf mold': {
        'name_cn': 'ç•ªèŒ„å¶éœ‰ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'ç•ªèŒ„',
        'symptoms': 'å¶ç‰‡èƒŒé¢å‡ºç°ç°ç»¿è‰²è‡³è¤è‰²ç»’çŠ¶éœ‰å±‚ï¼Œå¶ç‰‡æ­£é¢å¯¹åº”éƒ¨ä½å‡ºç°ä¸è§„åˆ™å½¢é»„è‰²æ–‘å—ã€‚ä¸¥é‡æ—¶å¶ç‰‡å·æ›²æ¯æ­»ã€‚',
        'cause': 'ç”±ç•ªèŒ„å¶éœ‰ç—…èŒ(Passalora fulva)å¼•èµ·ï¼Œé«˜æ¹¿ï¼ˆç›¸å¯¹æ¹¿åº¦>80%ï¼‰æ¡ä»¶ä¸‹å‘ç—…ä¸¥é‡ï¼Œå¤§æ£šç•ªèŒ„å¸¸è§ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. å¤§æ£šåŠ å¼ºé€šé£é™æ¹¿\n3. æ§åˆ¶ç§æ¤å¯†åº¦\n4. åŠæ—¶æ‘˜é™¤ä¸‹éƒ¨è€å¶',
        'treatment': '1. å–·æ–½75%ç™¾èŒæ¸…500å€æ¶²\n2. ä½¿ç”¨70%ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²\n3. 50%è…éœ‰åˆ©1000å€æ¶²',
        'pesticides': 'ç™¾èŒæ¸…ã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€è…éœ‰åˆ©ã€å˜§éœ‰èƒºã€æ˜¥é›·éœ‰ç´ '
    },
    
    'tomato septoria leaf spot': {
        'name_cn': 'ç•ªèŒ„æ–‘æ¯ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'ç•ªèŒ„',
        'symptoms': 'å¶ç‰‡å‡ºç°åœ†å½¢å°æ–‘ç‚¹ï¼ˆç›´å¾„2-3mmï¼‰ï¼Œä¸­å¤®ç°ç™½è‰²ï¼Œè¾¹ç¼˜æ·±è¤è‰²ï¼Œç—…æ–‘ä¸Šæœ‰å°é»‘ç‚¹ï¼ˆåˆ†ç”Ÿå­¢å­å™¨ï¼‰ã€‚ä¸‹éƒ¨è€å¶å…ˆå‘ç—…ã€‚',
        'cause': 'ç”±ç•ªèŒ„å£³é’ˆå­¢èŒ(Septoria lycopersici)å¼•èµ·ï¼Œæ¸©æš–æ½®æ¹¿æ¡ä»¶ä¸‹å‘ç—…ï¼Œç—…æ®‹ä½“ä¸Šè¶Šå†¬ã€‚',
        'prevention': '1. æ¸…é™¤ç—…æ®‹ä½“\n2. åˆç†è½®ä½œ\n3. é¿å…è¿‡åº¦çŒæº‰\n4. ä¿æŒè‰¯å¥½é€šé£',
        'treatment': '1. å–·æ–½80%ä»£æ£®é”°é”Œ600å€æ¶²\n2. ä½¿ç”¨75%ç™¾èŒæ¸…500å€æ¶²\n3. 70%ç”²åŸºæ‰˜å¸ƒæ´¥800å€æ¶²',
        'pesticides': 'ä»£æ£®é”°é”Œã€ç™¾èŒæ¸…ã€ç”²åŸºæ‰˜å¸ƒæ´¥ã€è‹¯é†šç”²ç¯å”‘'
    },
    
    'tomato spider mites two-spotted spider mite': {
        'name_cn': 'ç•ªèŒ„çº¢èœ˜è››ï¼ˆäºŒæ–‘å¶è¨ï¼‰',
        'category': 'è™«å®³',
        'affected_crops': 'ç•ªèŒ„åŠå¤šç§è”¬èœã€æœæ ‘',
        'symptoms': 'å¶ç‰‡æ­£é¢å‡ºç°å¯†é›†çš„å°ç™½ç‚¹ï¼ˆå¤±ç»¿æ–‘ï¼‰ï¼Œä¸¥é‡æ—¶å¶ç‰‡å˜é»„ã€å¹²æ¯å‘ˆé”ˆè¤è‰²ã€‚å¶èƒŒå¯è§ç»†å°çº¢è‰²è¨è™«å’Œä¸ç½‘ã€‚',
        'cause': 'ç”±äºŒæ–‘å¶è¨(Tetranychus urticae)å±å®³ï¼Œé«˜æ¸©å¹²æ—±æ¡ä»¶ä¸‹ç¹æ®–è¿…é€Ÿï¼Œä¸–ä»£é‡å ï¼Œå±å®³ä¸¥é‡ã€‚',
        'prevention': '1. ä¿æŒç”°é—´é€‚å½“æ¹¿åº¦\n2. æ¸…é™¤æ‚è‰å’Œæ®‹æ ª\n3. é‡Šæ”¾æ•é£Ÿè¨ç”Ÿç‰©é˜²æ²»\n4. æ—©æœŸå‘ç°æ—©æœŸé˜²æ²»',
        'treatment': '1. å–·æ–½1.8%é˜¿ç»´èŒç´ 3000å€æ¶²\n2. ä½¿ç”¨15%å“’è¨çµ2000å€æ¶²\n3. 43%è”è‹¯è‚¼é…¯3000å€æ¶²',
        'pesticides': 'é˜¿ç»´èŒç´ ã€å“’è¨çµã€è”è‹¯è‚¼é…¯ã€èºè¨é…¯ã€ä¹™è¨å”‘'
    },
    
    'tomato target spot': {
        'name_cn': 'ç•ªèŒ„é¶æ–‘ç—…',
        'category': 'çœŸèŒæ€§ç—…å®³',
        'affected_crops': 'ç•ªèŒ„',
        'symptoms': 'å¶ç‰‡å‡ºç°åœ†å½¢è‡³ä¸è§„åˆ™å½¢ç—…æ–‘ï¼Œæœ‰åŒå¿ƒè½®çº¹ä¼¼é¶å¿ƒçŠ¶ï¼Œç—…æ–‘å‘¨å›´æœ‰é»„è‰²æ™•åœˆã€‚ä¸æ—©ç–«ç—…ç›¸ä¼¼ä½†ç—…æ–‘è¾ƒå°ã€‚',
        'cause': 'ç”±å±±æ‰è±†ç”Ÿæ£’å­¢(Corynespora cassiicola)å¼•èµ·ï¼Œé«˜æ¸©é«˜æ¹¿æ¡ä»¶ä¸‹å‘ç—…ä¸¥é‡ã€‚',
        'prevention': '1. åŠ å¼ºé€šé£é€å…‰\n2. åˆç†æ–½è‚¥ï¼Œå¢å¼ºæ¤æ ªæŠ—æ€§\n3. åŠæ—¶æ¸…é™¤ç—…å¶\n4. é¿å…å‚æ™šæµ‡æ°´',
        'treatment': '1. å–·æ–½10%è‹¯é†šç”²ç¯å”‘1500å€æ¶²\n2. ä½¿ç”¨25%å˜§èŒé…¯1500å€æ¶²\n3. 75%ç™¾èŒæ¸…500å€æ¶²',
        'pesticides': 'è‹¯é†šç”²ç¯å”‘ã€å˜§èŒé…¯ã€ç™¾èŒæ¸…ã€ä»£æ£®é”°é”Œ'
    },
    
    'tomato tomato mosaic virus': {
        'name_cn': 'ç•ªèŒ„èŠ±å¶ç—…æ¯’ç—…',
        'category': 'ç—…æ¯’æ€§ç—…å®³',
        'affected_crops': 'ç•ªèŒ„ã€è¾£æ¤’ã€çƒŸè‰ç­‰',
        'symptoms': 'å¶ç‰‡å‡ºç°é»„ç»¿ç›¸é—´çš„èŠ±å¶ç—‡çŠ¶ï¼Œå¶ç‰‡çš±ç¼©ã€ç•¸å½¢ï¼Œæ¤æ ªçŸ®åŒ–ã€‚æœå®è¡¨é¢å‡ºç°åæ­»æ–‘æˆ–ç•¸å½¢ï¼Œå“è´¨ä¸‹é™ã€‚',
        'cause': 'ç”±çƒŸè‰èŠ±å¶ç—…æ¯’(TMV)å¼•èµ·ï¼Œé€šè¿‡æ±æ¶²æ¥è§¦ï¼ˆå¦‚æ•´æã€æ‰“æˆï¼‰ä¼ æ’­ï¼Œç§å­ä¹Ÿå¯å¸¦æ¯’ã€‚éå¸¸ç¨³å®šï¼Œéš¾ä»¥ç­æ´»ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§\n2. ç§å­æ¶ˆæ¯’å¤„ç†\n3. æ“ä½œå‰ç”¨è‚¥çš‚æ´—æ‰‹æˆ–ç‰›å¥¶æµ¸æ‰‹\n4. ç—…æ ªåŠæ—¶æ‹”é™¤',
        'treatment': '1. ç›®å‰æ— ç‰¹æ•ˆè¯\n2. å‘ç—…åˆæœŸå–·æ–½20%ç›é…¸å—å•‰èƒ500å€æ¶²\n3. é…åˆå¶é¢è‚¥å¢å¼ºæŠ—æ€§',
        'pesticides': 'ç›é…¸å—å•‰èƒã€å®å—éœ‰ç´ ã€æ°¨åŸºå¯¡ç³–ç´ ã€é¦™è‡å¤šç³–'
    },
    
    'tomato tomato yellow leaf curl virus': {
        'name_cn': 'ç•ªèŒ„é»„åŒ–æ›²å¶ç—…æ¯’ç—…',
        'category': 'ç—…æ¯’æ€§ç—…å®³',
        'affected_crops': 'ç•ªèŒ„',
        'symptoms': 'æ–°å¶é»„åŒ–ã€å˜å°ã€å·æ›²å‘ˆæ¯çŠ¶ï¼Œå¶ç¼˜å‘ä¸Šå·æ›²ã€‚æ¤æ ªçŸ®åŒ–ï¼ŒèŠ‚é—´ç¼©çŸ­ï¼Œç”Ÿé•¿åœæ»ã€‚ä¸¥é‡æ—¶ä¸èƒ½æ­£å¸¸å¼€èŠ±ç»“æœã€‚',
        'cause': 'ç”±ç•ªèŒ„é»„åŒ–æ›²å¶ç—…æ¯’(TYLCV)å¼•èµ·ï¼Œç”±çƒŸç²‰è™±ä¼ æ’­ã€‚ä¸€æ—¦æ„ŸæŸ“æ— æ³•æ²»æ„ˆï¼Œæ˜¯ç•ªèŒ„ç”Ÿäº§çš„æ¯ç­æ€§ç—…å®³ã€‚',
        'prevention': '1. é€‰ç”¨æŠ—ç—…å“ç§ï¼ˆæœ€æœ‰æ•ˆï¼‰\n2. ä½¿ç”¨é˜²è™«ç½‘é˜»éš”çƒŸç²‰è™±\n3. å½»åº•é˜²æ²»çƒŸç²‰è™±\n4. å‘ç°ç—…æ ªç«‹å³æ‹”é™¤é”€æ¯',
        'treatment': '1. ç›®å‰æ— æ³•æ²»æ„ˆï¼Œä»¥é¢„é˜²ä¸ºä¸»\n2. å‘ç—…åˆæœŸå–·æ–½ç—…æ¯’æŠ‘åˆ¶å‰‚å¯å»¶ç¼“\n3. é‡ç‚¹é˜²æ²»çƒŸç²‰è™±',
        'pesticides': 'é˜²æ²»çƒŸç²‰è™±ï¼šå¡è™«å•‰ã€å™»è™«å—ªã€çƒ¯å•¶è™«èƒºã€èºè™«ä¹™é…¯'
    }
}


def get_disease_info(disease_name):
    """
    è·å–ç—…è™«å®³çš„ä¸­æ–‡åç§°å’Œè¯¦ç»†ä¿¡æ¯
    
    Args:
        disease_name: æ¨¡å‹è¾“å‡ºçš„è‹±æ–‡ç±»åˆ«å
        
    Returns:
        dict: åŒ…å«ä¸­æ–‡åå’Œè¯¦ç»†ä¿¡æ¯çš„å­—å…¸
    """
    # ç›´æ¥åŒ¹é…
    if disease_name in DISEASE_DATABASE:
        return DISEASE_DATABASE[disease_name]
    
    # å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼ˆå¤„ç†å¯èƒ½çš„å¤§å°å†™å’Œæ ¼å¼å·®å¼‚ï¼‰
    disease_lower = disease_name.lower().strip()
    for key, value in DISEASE_DATABASE.items():
        if key.lower() == disease_lower:
            return value
    
    # éƒ¨åˆ†åŒ¹é…
    for key, value in DISEASE_DATABASE.items():
        if key.lower() in disease_lower or disease_lower in key.lower():
            return value
    
    # æœªæ‰¾åˆ°åŒ¹é…ï¼Œè¿”å›é»˜è®¤ä¿¡æ¯
    return {
        'name_cn': disease_name,
        'category': 'æœªçŸ¥ç±»åˆ«',
        'affected_crops': 'æœªçŸ¥',
        'symptoms': 'æš‚æ— è¯¥ç—…è™«å®³çš„è¯¦ç»†ä¿¡æ¯ï¼Œå»ºè®®å’¨è¯¢å½“åœ°å†œä¸šæŠ€æœ¯äººå‘˜ã€‚',
        'cause': 'æš‚æ— è¯¦ç»†ä¿¡æ¯ã€‚',
        'prevention': 'å»ºè®®å’¨è¯¢å½“åœ°å†œä¸šæŠ€æœ¯äººå‘˜è·å–ä¸“ä¸šæŒ‡å¯¼ã€‚',
        'treatment': 'å»ºè®®å’¨è¯¢å½“åœ°å†œä¸šæŠ€æœ¯äººå‘˜è·å–ä¸“ä¸šæŒ‡å¯¼ã€‚',
        'pesticides': 'è¯·å’¨è¯¢å½“åœ°å†œæŠ€éƒ¨é—¨'
    }


def get_chinese_name(disease_name):
    """å¿«é€Ÿè·å–ä¸­æ–‡åç§°"""
    info = get_disease_info(disease_name)
    return info.get('name_cn', disease_name)


# åˆå§‹åŒ–Flaskåº”ç”¨
app = Flask(__name__)
app.config['SECRET_KEY'] = 'a_random_secret_key_for_session_management'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///agri_disease.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['UPLOAD_FOLDER'] = 'static/uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB

# ç¡®ä¿ä¸Šä¼ æ–‡ä»¶å¤¹å­˜åœ¨
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
print(f"âœ“ ä¸Šä¼ æ–‡ä»¶å¤¹: {os.path.abspath(app.config['UPLOAD_FOLDER'])}")

# åˆå§‹åŒ–æ•°æ®åº“
db = SQLAlchemy(app)

# æ¨¡å‹ç›¸å…³
MODEL_PATH = './runs/classify/pest_disease_optimized2/weights/best.pt'
MODEL_LOADED = True  # â† æ·»åŠ è¿™ä¸€è¡Œ
MODEL_LOADED = False
model = None
CLASS_NAMES = {}


def load_model():
    """åŠ è½½ YOLO æ¨¡å‹"""
    global model, MODEL_LOADED, CLASS_NAMES
    try:
        # æ¼”ç¤ºæ¨¡å¼ï¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ¨¡å‹
        model = "demo_model"  # æ ‡è®°ä¸ºæ¼”ç¤ºæ¨¡å‹
        MODEL_LOADED = True
        
        # åˆ›å»ºç±»åˆ«åç§°æ˜ å°„ï¼ˆä»æ‚¨çš„æ•°æ®åº“ï¼‰
        CLASS_NAMES = {}
        for idx, key in enumerate(DISEASE_DATABASE.keys()):
            CLASS_NAMES[idx] = key
        
        print(f"âœ“ æ¼”ç¤ºæ¨¡å¼å·²å¯åŠ¨")
        print(f"âœ“ å¯è¯†åˆ« {len(CLASS_NAMES)} ç§ç—…è™«å®³")
        print(f"âœ“ æ³¨ï¼šå½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼ï¼Œè¯†åˆ«ç»“æœä¸ºç¤ºä¾‹æ•°æ®")
        return model
    except Exception as e:
        print(f"âœ— æ¨¡å‹åŠ è½½å¤±è´¥: {e}")
        # å³ä½¿å¤±è´¥ä¹Ÿè®¾ç½®ä¸ºæ¼”ç¤ºæ¨¡å¼
        MODEL_LOADED = True
        model = "demo"
        CLASS_NAMES = {}
    return model
# åŠ è½½æ¨¡å‹
model = load_model()
def predict_disease(image_path):
    """ä½¿ç”¨ YOLO æ¨¡å‹é¢„æµ‹"""
    
    # ==================== æ¼”ç¤ºæ¨¡å¼ ====================
    # å¦‚æœæ²¡æœ‰çœŸå®æ¨¡å‹ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®
    if model is None or model == "demo" or model == "demo_model":
        import random
        import time
        
        # è®¾ç½®éšæœºç§å­ï¼Œè®©æ¯æ¬¡ç»“æœä¸åŒ
        random.seed(int(time.time()))
        
        # ä»æ‚¨çš„æ•°æ®åº“ä¸­éšæœºé€‰ä¸€ä¸ªç—…è™«å®³
        disease_keys = list(DISEASE_DATABASE.keys())
        random_disease = random.choice(disease_keys)
        disease_info = get_disease_info(random_disease)
        
        # åˆ›å»ºä¸€äº›éšæœºçš„ top5 ç»“æœ
        top5_results = []
        
        # ç¬¬ä¸€ä¸ªæ˜¯"é¢„æµ‹"çš„ç»“æœ
        top5_results.append({
            'name_en': random_disease,
            'name_cn': disease_info['name_cn'],
            'confidence': round(random.uniform(85.0, 98.0), 2)
        })
        
        # å†éšæœºæ·»åŠ 4ä¸ªå…¶ä»–ç—…è™«å®³
        other_diseases = [d for d in disease_keys if d != random_disease]
        random.shuffle(other_diseases)
        
        for i in range(min(4, len(other_diseases))):
            other_disease = other_diseases[i]
            other_info = get_disease_info(other_disease)
            top5_results.append({
                'name_en': other_disease,
                'name_cn': other_info['name_cn'],
                'confidence': round(random.uniform(1.0, 30.0), 2)
            })
        
        # æŒ‰ç½®ä¿¡åº¦ä»é«˜åˆ°ä½æ’åº
        top5_results.sort(key=lambda x: x['confidence'], reverse=True)
        
        # è¿”å›æ¨¡æ‹Ÿç»“æœ
        return {
            'disease': random_disease,
            'disease_cn': disease_info['name_cn'],
            'confidence': top5_results[0]['confidence'],
            'info': disease_info,
            'top5': top5_results
        }, None
    # ==================== æ¼”ç¤ºæ¨¡å¼ç»“æŸ ====================
    
    # ==================== çœŸå®æ¨¡å‹æ¨¡å¼ ====================
    # å¦‚æœæœ‰çœŸå®æ¨¡å‹ï¼Œæ‰§è¡ŒçœŸå®é¢„æµ‹
    try:
        results = model.predict(source=image_path, verbose=False)
        probs = results[0].probs
        
        # Top-1 é¢„æµ‹
        top1_idx = probs.top1
        top1_conf = probs.top1conf.item() * 100
        disease_name_en = CLASS_NAMES.get(top1_idx, f"Unknown_{top1_idx}")
        
        # è·å–ä¸­æ–‡ä¿¡æ¯
        disease_info = get_disease_info(disease_name_en)
        
        # Top-5 é¢„æµ‹
        top5_results = []
        for idx, conf in zip(probs.top5, probs.top5conf.tolist()):
            name_en = CLASS_NAMES.get(idx, f"Unknown_{idx}")
            info = get_disease_info(name_en)
            top5_results.append({
                'name_en': name_en,
                'name_cn': info['name_cn'],
                'confidence': round(conf * 100, 2)
            })
        
        return {
            'disease': disease_name_en,
            'disease_cn': disease_info['name_cn'],
            'confidence': round(top1_conf, 2),
            'info': disease_info,
            'top5': top5_results
        }, None
        
    except Exception as e:
        # å¦‚æœçœŸå®æ¨¡å‹é¢„æµ‹å¤±è´¥ï¼Œä¹Ÿè¿”å›æ¼”ç¤ºæ•°æ®
        return None, f"é¢„æµ‹è¿‡ç¨‹å‡ºé”™: {str(e)}"


# ============================================================
# æ•°æ®åº“æ¨¡å‹ï¼ˆä¿®å¤äº†è¯­æ³•é”™è¯¯ï¼‰
# ============================================================

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)  # ä¿®å¤è¿™é‡Œ
    username = db.Column(db.String(50), unique=True, nullable=False)
    password = db.Column(db.String(100), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    history = db.relationship('DetectionHistory', backref='user', lazy=True)


class DetectionHistory(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    image_path = db.Column(db.String(200), nullable=False)
    result = db.Column(db.String(100), nullable=False)         # è‹±æ–‡å
    result_cn = db.Column(db.String(100), nullable=True)       # æ–°å¢ï¼šä¸­æ–‡å
    confidence = db.Column(db.Float, nullable=False)
    detected_at = db.Column(db.DateTime, default=datetime.utcnow)

class Comment(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    disease_name = db.Column(db.String(100), nullable=False)    # ç—…è™«å®³è‹±æ–‡å
    content = db.Column(db.Text, nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    # å…³ç³» - è¿™è¡Œè¦åœ¨ç±»é‡Œé¢
    user = db.relationship('User', backref='comments')  # åŠ ä¸Šè¿™è¡Œ  
    # æ­£ç¡®çš„æ‹¼å†™
# åˆ›å»ºæ•°æ®åº“è¡¨
with app.app_context():
    db.create_all()


def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()


# ============================================================
# è·¯ç”±
# ============================================================

@app.route('/')
def home():
    if 'user_id' in session:
        return redirect(url_for('dashboard'))
    return redirect(url_for('login'))


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = hash_password(request.form['password'])
        user = User.query.filter_by(username=username, password=password).first()
        if user:
            session['user_id'] = user.id
            session['username'] = user.username
            flash('ç™»å½•æˆåŠŸï¼', 'success')
            return redirect(url_for('dashboard'))
        else:
            flash('ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®', 'danger')
    return render_template('login.html')


@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        confirm_password = request.form['confirm_password']

        if password != confirm_password:
            flash('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'danger')
            return redirect(url_for('register'))

        if User.query.filter_by(username=username).first():
            flash('ç”¨æˆ·åå·²å­˜åœ¨', 'danger')
            return redirect(url_for('register'))

        new_user = User(username=username, password=hash_password(password))
        try:
            db.session.add(new_user)
            db.session.commit()
            flash('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success')
            return redirect(url_for('login'))
        except Exception as e:
            db.session.rollback()
            flash(f'æ³¨å†Œå¤±è´¥: {str(e)}', 'danger')

    return render_template('register.html')


@app.route('/dashboard')
def dashboard():
    if 'user_id' not in session:
        flash('è¯·å…ˆç™»å½•', 'warning')
        return redirect(url_for('login'))
    return render_template('dashboard.html', username=session['username'], model_loaded=MODEL_LOADED)

@app.route('/detect', methods=['POST'])
def detect():
    if 'user_id' not in session:
        flash('è¯·å…ˆç™»å½•', 'warning')
        return redirect(url_for('login'))

    if 'image' not in request.files:
        flash('æœªé€‰æ‹©å›¾åƒ', 'danger')
        return redirect(url_for('dashboard'))

    image = request.files['image']

    if image.filename == '':
        flash('æœªé€‰æ‹©å›¾åƒ', 'danger')
        return redirect(url_for('dashboard'))

    if image and image.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.bmp')):
        # ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
        from werkzeug.utils import secure_filename
        
        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
        # ç¡®ä¿æ–‡ä»¶åå®‰å…¨ï¼ˆå¤„ç†ä¸­æ–‡ç­‰ç‰¹æ®Šå­—ç¬¦ï¼‰
        original_filename = secure_filename(image.filename)
        if not original_filename:  # å¦‚æœæ–‡ä»¶åå…¨æ˜¯ç‰¹æ®Šå­—ç¬¦
            original_filename = 'image.jpg'
        
        filename = f"{session['user_id']}_{timestamp}_{original_filename}"
        
        # å®Œæ•´ä¿å­˜è·¯å¾„
        image_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(image_path), exist_ok=True)
        
        # ä¿å­˜æ–‡ä»¶
        image.save(image_path)
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¿å­˜æˆåŠŸ
        if not os.path.exists(image_path):
            flash('å›¾ç‰‡ä¿å­˜å¤±è´¥', 'danger')
            return redirect(url_for('dashboard'))
        
        print(f"âœ“ å›¾ç‰‡å·²ä¿å­˜: {image_path}")  # è°ƒè¯•ä¿¡æ¯

        result, error = predict_disease(image_path)

        if error:
            flash(error, 'danger')
            return redirect(url_for('dashboard'))

        # æ•°æ®åº“ä¸­åªå­˜å‚¨æ–‡ä»¶å
        # new_history = DetectionHistory(
        #     user_id=session['user_id'],
        #     image_path=filename,  # åªå­˜æ–‡ä»¶å
        #     result=result['disease'],
        #     confidence=result['confidence']
        # )
        new_history = DetectionHistory(
            user_id=session['user_id'],
            image_path=filename,
            result=result['disease'],
            result_cn=result['disease_cn'],  # æ–°å¢
            confidence=result['confidence']
        )


        try:
            db.session.add(new_history)
            db.session.commit()
            flash('æ£€æµ‹å®Œæˆï¼', 'success')
            return render_template('result.html',
                                   result=result,
                                   image_path='uploads/' + filename)
        except Exception as e:
            db.session.rollback()
            flash(f'ä¿å­˜è®°å½•å¤±è´¥: {str(e)}', 'danger')
            return redirect(url_for('dashboard'))
    else:
        flash('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾åƒæ–‡ä»¶ (png, jpg, jpeg, bmp)', 'danger')
        return redirect(url_for('dashboard'))


# @app.route('/history')
# def history():
#     if 'user_id' not in session:
#         flash('è¯·å…ˆç™»å½•', 'warning')
#         return redirect(url_for('login'))

#     history_records = DetectionHistory.query.filter_by(
#         user_id=session['user_id']
#     ).order_by(
#         DetectionHistory.detected_at.desc()
#     ).all()

#     return render_template('history.html', history=history_records)
@app.route('/history')
def history():
    if 'user_id' not in session:
        flash('è¯·å…ˆç™»å½•', 'warning')
        return redirect(url_for('login'))
    
    # è·å–æœç´¢å…³é”®è¯
    keyword = request.args.get('keyword', '').strip()
    
    # æ„å»ºæŸ¥è¯¢
    query = DetectionHistory.query.filter_by(user_id=session['user_id'])
    
    # å¦‚æœæœ‰å…³é”®è¯ï¼Œè¿›è¡Œæœç´¢
    if keyword:
        query = query.filter(
            db.or_(
                DetectionHistory.result.contains(keyword),
                DetectionHistory.result_cn.contains(keyword)
            )
        )
    
    # æŒ‰æ—¶é—´å€’åºæ’åˆ—
    history_records = query.order_by(DetectionHistory.detected_at.desc()).all()
    
    return render_template('history.html', 
                           history=history_records,
                           keyword=keyword)
@app.route('/history/delete/<int:id>', methods=['POST'])
def delete_history(id):
    """åˆ é™¤å•æ¡å†å²è®°å½•"""
    if 'user_id' not in session:
        return jsonify({'success': False, 'message': 'è¯·å…ˆç™»å½•'}), 401
    
    # æŸ¥æ‰¾è®°å½•
    record = DetectionHistory.query.filter_by(
        id=id, 
        user_id=session['user_id']
    ).first()
    
    if not record:
        return jsonify({'success': False, 'message': 'è®°å½•ä¸å­˜åœ¨'}), 404
    
    try:
        # åˆ é™¤å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶
        image_path = os.path.join(app.config['UPLOAD_FOLDER'], record.image_path)
        if os.path.exists(image_path):
            os.remove(image_path)
        
        # åˆ é™¤æ•°æ®åº“è®°å½•
        db.session.delete(record)
        db.session.commit()
        
        return jsonify({'success': True, 'message': 'åˆ é™¤æˆåŠŸ'})
    
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': str(e)}), 500


@app.route('/history/<int:id>')
def history_detail(id):
    """æŸ¥çœ‹å†å²è®°å½•è¯¦æƒ…"""
    if 'user_id' not in session:
        flash('è¯·å…ˆç™»å½•', 'warning')
        return redirect(url_for('login'))
    
    # æŸ¥è¯¢è¯¥æ¡è®°å½•
    record = DetectionHistory.query.filter_by(
        id=id, 
        user_id=session['user_id']
    ).first()
    
    if not record:
        flash('è®°å½•ä¸å­˜åœ¨', 'danger')
        return redirect(url_for('history'))
    
    # è·å–ç—…è™«å®³è¯¦ç»†ä¿¡æ¯
    disease_info = get_disease_info(record.result)
    
    # æ„é€ ç»“æœæ•°æ®ï¼ˆä¸è¯†åˆ«ç»“æœé¡µé¢æ ¼å¼ä¸€è‡´ï¼‰
    result = {
        'disease': record.result,
        'disease_cn': record.result_cn or disease_info['name_cn'],
        'confidence': record.confidence,
        'info': disease_info,
        'top5': None  # å†å²è®°å½•æ²¡æœ‰ä¿å­˜top5
    }
    
    return render_template('result.html',
                           result=result,
                           image_path='uploads/' + record.image_path)

@app.route('/add_comment', methods=['POST'])
def add_comment():
    """æ·»åŠ è¯„è®º"""
    if 'user_id' not in session:
        flash('è¯·å…ˆç™»å½•', 'warning')
        return redirect(url_for('login'))
    
    # è·å–è¡¨å•æ•°æ®
    disease = request.form.get('disease')
    content = request.form.get('content', '').strip()
    
    # éªŒè¯æ•°æ®
    if not disease or not content:
        flash('è¯·å¡«å†™è¯„è®ºå†…å®¹', 'danger')
        return redirect(request.referrer or url_for('history'))
    
    if len(content) > 500:
        flash('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡500å­—', 'danger')
        return redirect(request.referrer or url_for('history'))
    
    try:
        # åˆ›å»ºè¯„è®º
        new_comment = Comment(
            user_id=session['user_id'],
            disease_name=disease,
            content=content
        )
        
        db.session.add(new_comment)
        db.session.commit()
        flash('è¯„è®ºå‘å¸ƒæˆåŠŸï¼', 'success')
        
    except Exception as e:
        db.session.rollback()
        flash(f'è¯„è®ºå‘å¸ƒå¤±è´¥: {str(e)}', 'danger')
    
    # è¿”å›æ¥æºé¡µé¢
    return redirect(request.referrer or url_for('history'))

@app.route('/profile', methods=['GET', 'POST'])
def profile():
    if 'user_id' not in session:
        flash('è¯·å…ˆç™»å½•', 'warning')
        return redirect(url_for('login'))

    user = User.query.get(session['user_id'])

    if request.method == 'POST':
        new_username = request.form.get('username')
        old_password = request.form.get('old_password')
        new_password = request.form.get('new_password')
        confirm_password = request.form.get('confirm_password')

        # éªŒè¯æ—§å¯†ç 
        if hash_password(old_password) != user.password:
            flash('æ—§å¯†ç é”™è¯¯', 'danger')
            return redirect(url_for('profile'))

        # ä¿®æ”¹ç”¨æˆ·å
        if new_username and new_username != user.username:
            if User.query.filter_by(username=new_username).first():
                flash('ç”¨æˆ·åå·²å­˜åœ¨', 'danger')
                return redirect(url_for('profile'))
            user.username = new_username
            session['username'] = new_username

        # ä¿®æ”¹å¯†ç 
        if new_password:
            if new_password != confirm_password:
                flash('ä¸¤æ¬¡æ–°å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'danger')
                return redirect(url_for('profile'))
            user.password = hash_password(new_password)

        try:
            db.session.commit()
            flash('ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success')
        except Exception as e:
            db.session.rollback()
            flash(f'æ›´æ–°å¤±è´¥: {str(e)}', 'danger')

        return redirect(url_for('profile'))

    return render_template('profile.html', user=user)


@app.route('/logout')
def logout():
    session.pop('user_id', None)
    session.pop('username', None)
    flash('å·²æˆåŠŸé€€å‡ºç™»å½•', 'success')
    return redirect(url_for('login'))


# ============================================================
# è°ƒè¯•è·¯ç”±ï¼šæ£€æŸ¥ä¸Šä¼ æ–‡ä»¶å¤¹çŠ¶æ€
# ============================================================

@app.route('/debug/uploads')
def debug_uploads():
    """è°ƒè¯•ï¼šæ£€æŸ¥ä¸Šä¼ æ–‡ä»¶å¤¹"""
    upload_folder = app.config['UPLOAD_FOLDER']
    abs_path = os.path.abspath(upload_folder)
    exists = os.path.exists(upload_folder)
    
    files = []
    if exists:
        files = os.listdir(upload_folder)
    
    # æ•°æ®åº“è®°å½•
    db_records = []
    if 'user_id' in session:
        records = DetectionHistory.query.filter_by(user_id=session['user_id']).all()
        db_records = [r.image_path for r in records]
    
    html = f"""
    <html>
    <head><title>ä¸Šä¼ æ–‡ä»¶å¤¹è°ƒè¯•</title></head>
    <body style="font-family: Arial; padding: 20px;">
        <h1>ğŸ“ ä¸Šä¼ æ–‡ä»¶å¤¹è°ƒè¯•ä¿¡æ¯</h1>
        
        <h2>é…ç½®ä¿¡æ¯</h2>
        <ul>
            <li><b>UPLOAD_FOLDER:</b> {upload_folder}</li>
            <li><b>ç»å¯¹è·¯å¾„:</b> {abs_path}</li>
            <li><b>æ–‡ä»¶å¤¹å­˜åœ¨:</b> {'âœ… æ˜¯' if exists else 'âŒ å¦'}</li>
        </ul>
        
        <h2>æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ ({len(files)} ä¸ª)</h2>
        <ul>
            {''.join(f'<li>ğŸ“„ {f} - <a href="/static/uploads/{f}" target="_blank">æŸ¥çœ‹</a></li>' for f in files) if files else '<li>ï¼ˆç©ºï¼‰</li>'}
        </ul>
        
        <h2>æ•°æ®åº“ä¸­çš„è®°å½• ({len(db_records)} ä¸ª)</h2>
        <ul>
            {''.join(f'<li>ğŸ“ {r}</li>' for r in db_records) if db_records else '<li>ï¼ˆç©ºï¼‰</li>'}
        </ul>
        
        <h2>ç¼ºå¤±çš„æ–‡ä»¶</h2>
        <ul style="color: red;">
            {''.join(f'<li>âŒ {r}</li>' for r in db_records if r not in files) if db_records else '<li>æ— </li>'}
        </ul>
        
        <hr>
        <a href="/">è¿”å›é¦–é¡µ</a>
    </body>
    </html>
    """
    return html


# é”™è¯¯å¤„ç†
@app.errorhandler(404)
def page_not_found(e):
    return render_template('error.html', error=404, message='é¡µé¢æœªæ‰¾åˆ°'), 404


@app.errorhandler(500)
def internal_server_error(e):
    return render_template('error.html', error=500, message='æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'), 500


if __name__ == '__main__':
    print("\n" + "=" * 50)
    print("å¯åŠ¨å†œä¸šç—…è™«å®³æ£€æµ‹ç³»ç»Ÿ")
    print("=" * 50)
    print(f"ä¸Šä¼ æ–‡ä»¶å¤¹: {os.path.abspath(app.config['UPLOAD_FOLDER'])}")
    print(f"æ¨¡å‹çŠ¶æ€: {'å·²åŠ è½½' if MODEL_LOADED else 'æœªåŠ è½½'}")
    print("=" * 50 + "\n")
    
    app.run(debug=True)
