{% extends "base.html" %}

{% block title %}è¯†åˆ«ç»“æœ{% endblock %}

{% block extra_css %}
<style>
    .result-page {
        max-width: 900px;
        margin: 0 auto;
        padding: 1rem;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-title {
        color: #2d6a4f;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    /* å›¾ç‰‡éƒ¨åˆ† */
    .image-section {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .image-wrapper {
        position: relative;
        background: #f8f9fa;
        padding: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .result-image {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
        border-radius: 10px;
    }

    /* è¯†åˆ«ç»“æœå¡ç‰‡ */
    .result-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .result-header {
        text-align: center;
        padding-bottom: 1.5rem;
        border-bottom: 3px solid #e9ecef;
        margin-bottom: 2rem;
    }

    .disease-name-cn {
        font-size: 2rem;
        color: #2d6a4f;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .disease-name-en {
        color: #888;
        font-size: 1rem;
        font-style: italic;
        margin-bottom: 1rem;
    }

    .category-tag {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .category-fungal { background: #e8f5e9; color: #2e7d32; }
    .category-bacterial { background: #fff3e0; color: #ef6c00; }
    .category-viral { background: #fce4ec; color: #c2185b; }
    .category-pest { background: #e3f2fd; color: #1565c0; }
    .category-healthy { background: #e0f2f1; color: #00796b; }

    /* ç½®ä¿¡åº¦éƒ¨åˆ† */
    .confidence-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        margin-bottom: 2rem;
    }

    .confidence-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .confidence-circle small {
        font-size: 0.8rem;
        font-weight: normal;
        margin-top: 0.3rem;
    }

    .confidence-high { background: linear-gradient(135deg, #28a745, #20c997); }
    .confidence-medium { background: linear-gradient(135deg, #ffc107, #fd7e14); }
    .confidence-low { background: linear-gradient(135deg, #dc3545, #e83e8c); }

    .confidence-text {
        text-align: left;
    }

    .confidence-label {
        font-size: 1rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .confidence-hint {
        font-size: 1rem;
        color: #666;
    }

    /* ä¿¡æ¯å¡ç‰‡ç½‘æ ¼ */
    .info-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
        .info-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .info-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        border-left: 5px solid #2d6a4f;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .info-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .info-card h4 {
        color: #2d6a4f;
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-card p {
        color: #555;
        font-size: 0.95rem;
        line-height: 1.7;
        margin: 0;
        white-space: pre-line;
    }

    .info-card-full {
        grid-column: 1 / -1;
    }

    .pesticide-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.8rem;
    }

    .pesticide-tag {
        display: inline-block;
        background: #e3f2fd;
        color: #1565c0;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* Top5 éƒ¨åˆ† */
    .top5-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .top5-title {
        color: #2d6a4f;
        margin-bottom: 1.5rem;
        font-size: 1.3rem;
        text-align: center;
    }

    .top5-list {
        display: grid;
        gap: 0.8rem;
    }

    .top5-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        transition: all 0.2s;
    }

    .top5-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }

    .top5-item:first-child {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border: 2px solid #4caf50;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }

    .top5-rank {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #2d6a4f;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .top5-item:first-child .top5-rank {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .top5-name {
        flex: 1;
    }

    .top5-name-cn {
        font-weight: 600;
        color: #333;
        font-size: 1rem;
        margin-bottom: 0.2rem;
    }

    .top5-name-en {
        font-size: 0.8rem;
        color: #888;
    }

    .top5-conf {
        font-weight: bold;
        color: #2d6a4f;
        font-size: 1.1rem;
        margin-left: 1rem;
    }

    /* æ“ä½œæŒ‰é’® */
    .action-section {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .action-section .btn {
        flex: 1;
        max-width: 200px;
        padding: 1rem 2rem;
        font-size: 1rem;
        text-align: center;
    }

    .btn-secondary {
        background: #6c757d;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
        .confidence-section {
            flex-direction: column;
            gap: 1rem;
        }

        .confidence-text {
            text-align: center;
        }

        .disease-name-cn {
            font-size: 1.5rem;
        }

        .action-section {
            flex-direction: column;
        }

        .action-section .btn {
            max-width: 100%;
        }
    }
    .comments-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .comments-title {
        color: #2d6a4f;
        margin-bottom: 1rem;
        font-size: 1.3rem;
        text-align: center;
    }
    .comment-item {
        border-bottom: 1px solid #eee;
        padding: 1rem 0;
    }
    .comment-meta {
        color: #777;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    .comment-content {
        color: #333;
        white-space: pre-line;
        line-height: 1.6;
    }
    .comment-form textarea {
        width: 100%;
        min-height: 100px;
        resize: vertical;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
    }
    .comment-form .actions {
        text-align: right;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="result-page">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <h1 class="page-title">ğŸ”¬ è¯†åˆ«ç»“æœ</h1>
    </div>

    <!-- ä¸Šä¼ çš„å›¾ç‰‡ -->
    <div class="image-section">
        <div class="image-wrapper">
            <img src="{{ url_for('static', filename=image_path) }}" 
                 alt="ä¸Šä¼ çš„æ¤ç‰©å›¾ç‰‡"
                 class="result-image"
                 onerror="this.src='{{ url_for('static', filename='images/no-image.png') }}'">
        </div>
    </div>

    <!-- è¯†åˆ«ç»“æœ -->
    <div class="result-section">
        <div class="result-header">
            <div class="disease-name-cn">ğŸŒ¿ {{ result.disease_cn or result.disease }}</div>
            <div class="disease-name-en">{{ result.disease }}</div>
            
            {% if result.info %}
                {% set category = result.info.category %}
                <span class="category-tag 
                    {% if 'çœŸèŒ' in category %}category-fungal
                    {% elif 'ç»†èŒ' in category %}category-bacterial
                    {% elif 'ç—…æ¯’' in category %}category-viral
                    {% elif 'è™«' in category %}category-pest
                    {% elif 'å¥åº·' in category %}category-healthy
                    {% else %}category-fungal{% endif %}">
                    {{ category }}
                </span>
            {% endif %}
        </div>

        <!-- ç½®ä¿¡åº¦ -->
        <div class="confidence-section">
            <div class="confidence-circle 
                {% if result.confidence >= 80 %}confidence-high
                {% elif result.confidence >= 60 %}confidence-medium
                {% else %}confidence-low{% endif %}">
                <div>{{ result.confidence }}%</div>
                <small>ç½®ä¿¡åº¦</small>
            </div>
            <div class="confidence-text">
                <div class="confidence-label">è¯†åˆ«å¯ä¿¡åº¦</div>
                <div class="confidence-hint">
                    {% if result.confidence >= 80 %}
                        âœ… å¯ä¿¡åº¦é«˜ï¼Œè¯†åˆ«ç»“æœå¯é 
                    {% elif result.confidence >= 60 %}
                        âš ï¸ å¯ä¿¡åº¦ä¸­ç­‰ï¼Œå»ºè®®ç»“åˆå®é™…æƒ…å†µåˆ¤æ–­
                    {% else %}
                        â— å¯ä¿¡åº¦è¾ƒä½ï¼Œå»ºè®®é‡æ–°æ‹ç…§æˆ–å’¨è¯¢ä¸“å®¶
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†ä¿¡æ¯ç½‘æ ¼ -->
        {% if result.info %}
        <div class="info-grid">
            {% if result.info.symptoms and result.info.symptoms != 'æš‚æ— è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å’¨è¯¢å½“åœ°å†œä¸šæŠ€æœ¯äººå‘˜ã€‚' %}
            <div class="info-card">
                <h4>ğŸ” ç—‡çŠ¶ç‰¹å¾</h4>
                <p>{{ result.info.symptoms }}</p>
            </div>
            {% endif %}
            
            {% if result.info.cause and result.info.cause != '-' and result.info.cause != 'æš‚æ— è¯¦ç»†ä¿¡æ¯ã€‚' and result.info.cause != 'æ— ç—…å®³' %}
            <div class="info-card">
                <h4>ğŸ¦  å‘ç—…åŸå› </h4>
                <p>{{ result.info.cause }}</p>
            </div>
            {% endif %}
            
            {% if result.info.prevention and result.info.prevention != '-' %}
            <div class="info-card {% if result.info.treatment == '-' or result.info.treatment == 'æ— éœ€æ²»ç–—' %}info-card-full{% endif %}">
                <h4>ğŸ›¡ï¸ é¢„é˜²æªæ–½</h4>
                <p>{{ result.info.prevention }}</p>
            </div>
            {% endif %}
            
            {% if result.info.treatment and result.info.treatment != '-' and result.info.treatment != 'æ— éœ€æ²»ç–—' %}
            <div class="info-card">
                <h4>ğŸ’Š æ²»ç–—æ–¹æ³•</h4>
                <p>{{ result.info.treatment }}</p>
            </div>
            {% endif %}
            
            {% if result.info.pesticides and result.info.pesticides != '-' and result.info.pesticides != 'æ— éœ€ç”¨è¯' and result.info.pesticides != 'è¯·å’¨è¯¢å½“åœ°å†œæŠ€éƒ¨é—¨' %}
            <div class="info-card info-card-full">
                <h4>ğŸ§ª æ¨èå†œè¯</h4>
                <div class="pesticide-tags">
                    {% for pesticide in result.info.pesticides.split('ã€') %}
                        <span class="pesticide-tag">{{ pesticide.strip() }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="comments-section">
        <h4 class="comments-title">ğŸ’¬ è¯„è®ºåŒº</h4>
        {% if comments and comments|length > 0 %}
            <div class="comments-list">
                {% for c in comments %}
                    <div class="comment-item">
                        <div class="comment-meta">
                            {{ c.user.username if c.user else 'åŒ¿å' }} Â· {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        <div class="comment-content">{{ c.content }}</div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="text-align:center; color:#777; margin-bottom:1rem;">è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢ç¬¬ä¸€æ¡å§</p>
        {% endif %}
        {% if 'user_id' in session %}
        <form class="comment-form" method="POST" action="{{ url_for('add_comment') }}">
    <input type="hidden" name="history_id" value="{{ history_id }}">
    <input type="hidden" name="disease" value="{{ result.disease }}">

            <textarea name="content" placeholder="å‘è¡¨ä½ çš„è§è§£æˆ–ç»éªŒ"></textarea>
            <div class="actions">
                <button type="submit" class="btn">å‘å¸ƒè¯„è®º</button>
            </div>
        </form>
        {% else %}
            <p style="text-align:center; color:#777;">è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º</p>
        {% endif %}
    </div>

    <!-- Top5 é¢„æµ‹ç»“æœ -->
    {% if result.top5 and result.top5|length > 1 %}
    <div class="top5-section">
        <h4 class="top5-title">ğŸ“Š å…¶ä»–å¯èƒ½çš„è¯†åˆ«ç»“æœ</h4>
        <div class="top5-list">
            {% for item in result.top5 %}
            <div class="top5-item">
                <div class="top5-rank">{{ loop.index }}</div>
                <div class="top5-name">
                    <div class="top5-name-cn">{{ item.name_cn or item.name_en }}</div>
                    <div class="top5-name-en">{{ item.name_en }}</div>
                </div>
                <div class="top5-conf">{{ item.confidence }}%</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="action-section">
        <a href="{{ url_for('dashboard') }}" class="btn">ğŸ“· ç»§ç»­è¯†åˆ«</a>
        <a href="{{ url_for('history') }}" class="btn btn-secondary">ğŸ“‹ æŸ¥çœ‹å†å²</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.onload = function() {
        // é¡µé¢æ·¡å…¥åŠ¨ç”»
        const sections = document.querySelectorAll('.image-section, .result-section, .top5-section');
        sections.forEach((section, index) => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(30px)';
            section.style.transition = 'all 0.6s ease';
            
            setTimeout(() => {
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, 100 * (index + 1));
        });
    };
</script>
{% endblock %}
