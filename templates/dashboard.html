{% extends "base.html" %}

{% block title %}é¦–é¡µ{% endblock %}

{% block extra_css %}
<style>
    .welcome-header {
        text-align: center;
        margin-bottom: 2.5rem;
    }

    .welcome-title {
        color: #2d6a4f;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .welcome-subtitle {
        color: #666;
        font-size: 1rem;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    @media (min-width: 992px) {
        .dashboard-grid {
            grid-template-columns: 3fr 2fr;
        }
    }

    /* å·¦ä¾§åŒºåŸŸ */
    .left-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* ä¸Šä¼ åŒºåŸŸå¡ç‰‡ */
    .upload-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .upload-card h2 {
        color: #2d6a4f;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .upload-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .upload-area {
        border: 3px dashed #ccc;
        border-radius: 15px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #fafafa;
    }
    
    .upload-area:hover {
        border-color: #2d6a4f;
        background: #f0f7f4;
    }

    .upload-area.has-image {
        padding: 1.5rem;
        border-style: solid;
        border-color: #2d6a4f;
        background: #f0f7f4;
    }

    .upload-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .upload-text h3 {
        color: #333;
        margin-bottom: 0.5rem;
    }

    .upload-text p {
        color: #888;
        font-size: 0.9rem;
        margin: 0;
    }

    /* å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
    .preview-container {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .preview-container.show {
        display: flex;
    }

    .preview-wrapper {
        position: relative;
        width: 100%;
        max-width: 400px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        background: #f8f9fa;
    }

    .preview-image {
        width: 100%;
        max-height: 350px;
        object-fit: contain;
        display: block;
    }

    .preview-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn-remove {
        background: #dc3545;
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
    }

    .btn-remove:hover {
        background: #c82333;
    }

    .btn-submit {
        padding: 0.8rem 2.5rem;
        font-size: 1.1rem;
    }

    /* ä¸Šä¼ æç¤ºéšè— */
    .upload-hint {
        transition: all 0.3s;
    }

    .upload-hint.hide {
        display: none;
    }

    /* åŠŸèƒ½å¡ç‰‡åŒºåŸŸ */
    .features-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .feature-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .feature-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .feature-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .feature-icon {
        font-size: 2.5rem;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border-radius: 15px;
    }

    .feature-title {
        font-size: 1.2rem;
        color: #2d6a4f;
        margin: 0;
    }

    .feature-desc {
        color: #666;
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 1rem;
    }

    .feature-card .btn {
        width: 100%;
        text-align: center;
    }

    /* çŠ¶æ€æç¤º */
    .status-card {
        background: linear-gradient(135deg, #2d6a4f, #40916c);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
    }

    .status-card h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
    }

    .status-card p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.9rem;
    }

    .status-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    /* æ¨¡å‹è­¦å‘Š */
    .model-warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .model-warning-icon {
        font-size: 1.5rem;
    }

    .model-warning-text {
        color: #856404;
        font-size: 0.9rem;
    }

    /* æ‹–æ‹½ä¸Šä¼ æ ·å¼ */
    .upload-area.dragover {
        border-color: #2d6a4f;
        background: #e8f5e9;
        transform: scale(1.02);
    }

    /* ä½¿ç”¨æç¤ºåˆ—è¡¨ */
    .tips-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .tips-list li {
        padding: 0.5rem 0;
        color: #555;
        font-size: 0.95rem;
        border-bottom: 1px solid #eee;
    }

    .tips-list li:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- æ¬¢è¿æ ‡é¢˜ -->
<div class="welcome-header">
    <h1 class="welcome-title">ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ{{ username }}ï¼</h1>
    <p class="welcome-subtitle">ä¸Šä¼ æ¤ç‰©å¶ç‰‡å›¾ç‰‡ï¼Œæ™ºèƒ½è¯†åˆ«ç—…è™«å®³</p>
</div>

<div class="dashboard-grid">
    <!-- å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ + ä½¿ç”¨æç¤º -->
    <div class="left-section">
        <!-- ä¸Šä¼ å¡ç‰‡ -->
        <div class="upload-card">
            <h2>ğŸ”¬ ç—…è™«å®³è¯†åˆ«</h2>
            
            {% if not model_loaded %}
            <div class="model-warning">
                <span class="model-warning-icon">âš ï¸</span>
                <span class="model-warning-text">æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
            </div>
            {% endif %}
            
            <form id="uploadForm" method="POST" action="{{ url_for('detect') }}" enctype="multipart/form-data">
                <div class="upload-container">
                    <!-- ä¸Šä¼ åŒºåŸŸ -->
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageInput').click()">
                        <div class="upload-hint" id="uploadHint">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">
                                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</h3>
                                <p>æ”¯æŒ PNG, JPG, JPEG, BMP æ ¼å¼</p>
                            </div>
                        </div>
                        
                        <!-- å›¾ç‰‡é¢„è§ˆ -->
                        <div class="preview-container" id="previewContainer">
                            <div class="preview-wrapper">
                                <img id="imagePreview" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
                            </div>
                        </div>
                        
                        <input type="file" id="imageInput" name="image" accept="image/*" style="display: none;" 
                               onchange="previewImage(event)">
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="preview-actions" id="previewActions">
                        <button type="button" class="btn-remove" onclick="removeImage(event)">
                            ğŸ—‘ï¸ é‡æ–°é€‰æ‹©
                        </button>
                        <button type="submit" class="btn btn-submit" {% if not model_loaded %}disabled{% endif %}>
                            ğŸ” å¼€å§‹è¯†åˆ«
                        </button>
                    </div>
                    
                    <!-- æœªé€‰æ‹©å›¾ç‰‡æ—¶çš„æäº¤æŒ‰é’® -->
                    <div id="defaultSubmit" style="text-align: center;">
                        <button type="submit" class="btn btn-submit" {% if not model_loaded %}disabled{% endif %}>
                            ğŸ” å¼€å§‹è¯†åˆ«
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- ä½¿ç”¨æç¤º -->
        <div class="feature-card">
            <div class="feature-header">
                <div class="feature-icon">ğŸ’¡</div>
                <h3 class="feature-title">ä½¿ç”¨æç¤º</h3>
            </div>
            <p class="feature-desc">ä¸ºè·å¾—æœ€ä½³è¯†åˆ«æ•ˆæœï¼š</p>
            <ul class="tips-list">
                <li>ğŸ“¸ ä¸Šä¼ æ¸…æ™°çš„å¶ç‰‡ç‰¹å†™å›¾ç‰‡</li>
                <li>ğŸ” ç¡®ä¿ç—…æ–‘éƒ¨ä½å®Œæ•´å¯è§</li>
                <li>ğŸŒ¿ å°½é‡åªæ‹æ‘„å•ç‰‡å¶å­</li>
            </ul>
        </div>
    </div>
    
    <!-- å³ä¾§ï¼šåŠŸèƒ½åŒºåŸŸ -->
    <div class="features-section">
        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div class="status-card">
            <div class="status-icon">{{ 'âœ…' if model_loaded else 'âŒ' }}</div>
            <h4>ç³»ç»ŸçŠ¶æ€</h4>
            <p>{{ 'æ¨¡å‹å·²åŠ è½½ï¼Œå¯ä»¥è¿›è¡Œè¯†åˆ«' if model_loaded else 'æ¨¡å‹æœªåŠ è½½' }}</p>
        </div>
        
        <!-- æ™ºèƒ½è¯†åˆ«ä»‹ç» -->
        <div class="feature-card">
            <div class="feature-header">
                <div class="feature-icon">ğŸŒ¿</div>
                <h3 class="feature-title">æ™ºèƒ½è¯†åˆ«</h3>
            </div>
            <p class="feature-desc">
                é‡‡ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼Œæ”¯æŒè¯†åˆ« 38 ç§å¸¸è§å†œä½œç‰©ç—…è™«å®³ï¼ŒåŒ…æ‹¬è‹¹æœã€ç•ªèŒ„ã€é©¬é“ƒè–¯ã€ç‰ç±³ã€è‘¡è„ç­‰ä½œç‰©çš„å¤šç§ç—…å®³ã€‚
            </p>
        </div>
        
        <!-- å†å²è®°å½• -->
        <div class="feature-card">
            <div class="feature-header">
                <div class="feature-icon">ğŸ“‹</div>
                <h3 class="feature-title">å†å²è®°å½•</h3>
            </div>
            <p class="feature-desc">
                æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰è¯†åˆ«è®°å½•ï¼Œè¿½è¸ªæ¤ç‰©å¥åº·çŠ¶å†µï¼Œéšæ—¶å›é¡¾å†å²è¯Šæ–­ç»“æœã€‚
            </p>
            <a href="{{ url_for('history') }}" class="btn">
                ğŸ“Š æŸ¥çœ‹å†å²è®°å½•
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const uploadHint = document.getElementById('uploadHint');
    const previewContainer = document.getElementById('previewContainer');
    const previewActions = document.getElementById('previewActions');
    const defaultSubmit = document.getElementById('defaultSubmit');
    const imagePreview = document.getElementById('imagePreview');
    const imageInput = document.getElementById('imageInput');

    // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                
                // æ˜¾ç¤ºé¢„è§ˆï¼Œéšè—ä¸Šä¼ æç¤º
                uploadHint.classList.add('hide');
                previewContainer.classList.add('show');
                uploadArea.classList.add('has-image');
                
                // æ˜¾ç¤ºæ“ä½œæŒ‰é’®ï¼Œéšè—é»˜è®¤æäº¤
                previewActions.style.display = 'flex';
                defaultSubmit.style.display = 'none';
            }
            
            reader.readAsDataURL(file);
        }
    }

    // ç§»é™¤å›¾ç‰‡
    function removeImage(event) {
        event.stopPropagation();
        
        // æ¸…ç©ºè¾“å…¥
        imageInput.value = '';
        imagePreview.src = '';
        
        // æ¢å¤ä¸Šä¼ æç¤º
        uploadHint.classList.remove('hide');
        previewContainer.classList.remove('show');
        uploadArea.classList.remove('has-image');
        
        // éšè—æ“ä½œæŒ‰é’®ï¼Œæ˜¾ç¤ºé»˜è®¤æäº¤
        previewActions.style.display = 'none';
        defaultSubmit.style.display = 'block';
    }

    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            imageInput.files = files;
            previewImage({ target: imageInput });
        }
    });

    // è¡¨å•æäº¤å‰æ£€æŸ¥
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        if (!imageInput.files || imageInput.files.length === 0) {
            e.preventDefault();
            alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡');
        }
    });

    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    previewActions.style.display = 'none';
</script>
{% endblock %}
